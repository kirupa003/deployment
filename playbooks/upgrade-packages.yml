---
# Package Upgrade Playbook
# Rolling updates with configurable batch sizes
# Requirements: 4.2, 4.4

- name: VPN Infrastructure Package Upgrade
  hosts: vpn_servers
  become: yes
  gather_facts: yes
  serial: "{{ upgrade_batch_size | default(5) }}"
  max_fail_percentage: "{{ max_failure_percentage | default(10) }}"
  
  vars:
    upgrade_timestamp: "{{ ansible_date_time.epoch }}"
    upgrade_id: "upgrade-{{ upgrade_timestamp }}"
    upgrade_type: "{{ upgrade_type | default('security') }}"  # security, all, kernel
    reboot_required: false
    
  pre_tasks:
    - name: Validate upgrade prerequisites
      block:
        - name: Check system uptime
          command: uptime -s
          register: system_uptime
          changed_when: false
          
        - name: Verify sufficient disk space
          assert:
            that:
              - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 1073741824
            fail_msg: "Insufficient disk space for package upgrade (minimum 1GB required)"
            
        - name: Check for running critical processes
          shell: |
            pgrep -f "openvpn|wireguard|wg-quick" | wc -l
          register: critical_processes
          changed_when: false
          
        - name: Verify backup connectivity
          wait_for:
            host: "{{ backup_server | default('backup.example.com') }}"
            port: 22
            timeout: 10
          delegate_to: localhost
          when: verify_backup_connectivity | default(true)
          
    - name: Create upgrade log entry
      lineinfile:
        path: /var/log/package-upgrades.log
        line: "{{ ansible_date_time.iso8601 }} - Starting {{ upgrade_type }} upgrade {{ upgrade_id }} on {{ inventory_hostname }}"
        create: yes
        
    - name: Backup current package state
      shell: |
        dpkg --get-selections > /tmp/package-state-pre-upgrade-{{ upgrade_id }}.txt
        apt list --installed > /tmp/installed-packages-pre-upgrade-{{ upgrade_id }}.txt
      changed_when: false

  tasks:
    # Pre-upgrade health check
    - name: Pre-upgrade health verification
      block:
        - name: Check service status before upgrade
          systemd:
            name: "{{ item }}"
          register: pre_upgrade_services
          loop:
            - ssh
            - ufw
            - fail2ban
            - crowdsec
            - node_exporter
            - promtail
            - coredns
            - "{{ 'wg-quick@' + (wireguard_interface | default('wg0')) if 'wireguard_servers' in group_names else omit }}"
            - "{{ 'openvpn@server' if 'openvpn_servers' in group_names else omit }}"
          when: item != omit
          
        - name: Test VPN connectivity before upgrade
          block:
            - name: Test WireGuard connectivity
              command: wg show {{ wireguard_interface | default('wg0') }}
              register: pre_wg_status
              when: "'wireguard_servers' in group_names"
              changed_when: false
              
            - name: Test OpenVPN connectivity
              command: systemctl is-active openvpn@server
              register: pre_ovpn_status
              when: "'openvpn_servers' in group_names"
              changed_when: false
              
        - name: Record baseline metrics
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ node_exporter_port | default(9100) }}/metrics"
            method: GET
            return_content: yes
          register: pre_upgrade_metrics
          
    # Package update and upgrade
    - name: Package Management
      block:
        - name: Update package cache
          apt:
            update_cache: yes
            cache_valid_time: 0
            
        - name: Check for available upgrades
          shell: |
            apt list --upgradable 2>/dev/null | grep -v "WARNING" | wc -l
          register: available_upgrades
          changed_when: false
          
        - name: List security updates
          shell: |
            unattended-upgrade --dry-run 2>&1 | grep "^Inst " | wc -l
          register: security_updates
          changed_when: false
          when: upgrade_type == 'security'
          
        - name: Perform security-only upgrades
          apt:
            upgrade: safe
            autoremove: yes
            autoclean: yes
          register: security_upgrade_result
          when: upgrade_type == 'security'
          
        - name: Perform full package upgrade
          apt:
            upgrade: full
            autoremove: yes
            autoclean: yes
          register: full_upgrade_result
          when: upgrade_type == 'all'
          
        - name: Upgrade kernel packages
          apt:
            name: "{{ item }}"
            state: latest
          loop:
            - linux-image-generic
            - linux-headers-generic
            - linux-modules-extra-{{ ansible_kernel }}
          register: kernel_upgrade_result
          when: upgrade_type == 'kernel'
          
        - name: Check if reboot is required
          stat:
            path: /var/run/reboot-required
          register: reboot_required_file
          
        - name: Set reboot required flag
          set_fact:
            reboot_required: "{{ reboot_required_file.stat.exists }}"

    # Post-upgrade verification
    - name: Post-upgrade verification
      block:
        - name: Wait for system stability
          pause:
            seconds: 30
            
        - name: Verify critical services after upgrade
          systemd:
            name: "{{ item.item }}"
            state: started
          register: post_upgrade_services
          loop: "{{ pre_upgrade_services.results }}"
          when: item.item != omit
          
        - name: Test VPN connectivity after upgrade
          block:
            - name: Test WireGuard after upgrade
              command: wg show {{ wireguard_interface | default('wg0') }}
              register: post_wg_status
              when: "'wireguard_servers' in group_names"
              changed_when: false
              
            - name: Test OpenVPN after upgrade
              command: systemctl is-active openvpn@server
              register: post_ovpn_status
              when: "'openvpn_servers' in group_names"
              changed_when: false
              
        - name: Verify monitoring endpoints
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ item }}/metrics"
            method: GET
            status_code: 200
            timeout: 30
          loop:
            - "{{ node_exporter_port | default(9100) }}"
            - "{{ wg_exporter_port | default(9586) if 'wireguard_servers' in group_names else omit }}"
          when: item != omit
          register: post_upgrade_monitoring
          
        - name: Compare service states
          assert:
            that:
              - pre_upgrade_services.results | selectattr('state', 'equalto', 'started') | list | length == post_upgrade_services.results | selectattr('state', 'equalto', 'started') | list | length
            fail_msg: "Service state mismatch after upgrade"
            
    # Handle reboot if required
    - name: Handle system reboot
      block:
        - name: Notify about pending reboot
          debug:
            msg: "System reboot required after upgrade. Scheduling reboot..."
          when: reboot_required
          
        - name: Drain VPN connections before reboot
          block:
            - name: Disable new WireGuard connections
              lineinfile:
                path: /etc/wireguard/{{ wireguard_interface | default('wg0') }}.conf
                line: "# MAINTENANCE MODE - New connections disabled"
                insertafter: "^\\[Interface\\]"
              when: "'wireguard_servers' in group_names and reboot_required"
              
            - name: Disable new OpenVPN connections
              lineinfile:
                path: /etc/openvpn/server.conf
                line: "max-clients 0"
                regexp: "^max-clients"
              when: "'openvpn_servers' in group_names and reboot_required"
              notify: reload openvpn
              
            - name: Wait for connection drainage
              pause:
                seconds: "{{ connection_drain_time | default(300) }}"
              when: reboot_required
              
        - name: Perform system reboot
          reboot:
            reboot_timeout: "{{ reboot_timeout | default(600) }}"
            connect_timeout: "{{ connect_timeout | default(60) }}"
            test_command: uptime
          when: 
            - reboot_required
            - allow_reboot | default(true)
            
        - name: Re-enable VPN connections after reboot
          block:
            - name: Re-enable WireGuard connections
              lineinfile:
                path: /etc/wireguard/{{ wireguard_interface | default('wg0') }}.conf
                line: "# MAINTENANCE MODE - New connections disabled"
                state: absent
              when: "'wireguard_servers' in group_names and reboot_required"
              
            - name: Re-enable OpenVPN connections
              lineinfile:
                path: /etc/openvpn/server.conf
                line: "max-clients {{ max_clients | default(500) }}"
                regexp: "^max-clients"
              when: "'openvpn_servers' in group_names and reboot_required"
              notify: reload openvpn

  post_tasks:
    - name: Post-upgrade system validation
      block:
        - name: Verify system boot after reboot
          command: uptime
          register: post_reboot_uptime
          changed_when: false
          when: reboot_required
          
        - name: Check kernel version after upgrade
          command: uname -r
          register: post_upgrade_kernel
          changed_when: false
          
        - name: Verify all services are running
          systemd:
            name: "{{ item }}"
            state: started
          loop:
            - ssh
            - ufw
            - fail2ban
            - crowdsec
            - node_exporter
            - promtail
            - coredns
          register: final_service_check
          
        - name: Test VPN functionality
          block:
            - name: Final WireGuard test
              command: wg show {{ wireguard_interface | default('wg0') }}
              register: final_wg_test
              when: "'wireguard_servers' in group_names"
              changed_when: false
              
            - name: Final OpenVPN test
              command: systemctl is-active openvpn@server
              register: final_ovpn_test
              when: "'openvpn_servers' in group_names"
              changed_when: false
              
        - name: Generate upgrade report
          template:
            src: upgrade-report.j2
            dest: "/tmp/upgrade-report-{{ upgrade_id }}-{{ inventory_hostname }}.txt"
          vars:
            upgrade_summary:
              type: "{{ upgrade_type }}"
              packages_upgraded: "{{ (security_upgrade_result.stdout_lines | default([])) + (full_upgrade_result.stdout_lines | default([])) + (kernel_upgrade_result.results | default([]) | map(attribute='name') | list) }}"
              reboot_performed: "{{ reboot_required }}"
              services_verified: "{{ final_service_check.results | map(attribute='name') | list }}"
              kernel_version: "{{ post_upgrade_kernel.stdout }}"
              
        - name: Update upgrade log with completion
          lineinfile:
            path: /var/log/package-upgrades.log
            line: "{{ ansible_date_time.iso8601 }} - Completed {{ upgrade_type }} upgrade {{ upgrade_id }} on {{ inventory_hostname }} - Reboot: {{ 'YES' if reboot_required else 'NO' }} - Status: SUCCESS"

  handlers:
    - name: reload openvpn
      systemd:
        name: openvpn@server
        state: reloaded
        
    - name: restart wireguard
      systemd:
        name: "wg-quick@{{ wireguard_interface | default('wg0') }}"
        state: restarted

# Upgrade validation and rollback procedures
- name: Upgrade Validation and Rollback
  hosts: vpn_servers
  become: yes
  gather_facts: no
  serial: 1
  
  tasks:
    - name: Comprehensive upgrade validation
      block:
        - name: Validate package integrity
          command: dpkg --audit
          register: package_integrity_check
          changed_when: false
          
        - name: Check for broken packages
          command: apt-get check
          register: broken_packages_check
          changed_when: false
          
        - name: Verify system performance
          block:
            - name: Check system load after upgrade
              shell: uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | cut -d',' -f1
              register: post_upgrade_load
              changed_when: false
              
            - name: Check memory usage after upgrade
              shell: free | grep Mem | awk '{printf "%.2f", $3/$2 * 100.0}'
              register: post_upgrade_memory
              changed_when: false
              
        - name: Test network connectivity
          command: ping -c 3 8.8.8.8
          register: network_connectivity_test
          changed_when: false
          
      rescue:
        - name: Log upgrade validation failure
          lineinfile:
            path: /var/log/package-upgrades.log
            line: "{{ ansible_date_time.iso8601 }} - UPGRADE VALIDATION FAILED on {{ inventory_hostname }} - Initiating rollback procedures"
            
        - name: Attempt package rollback
          block:
            - name: Hold problematic packages
              command: apt-mark hold {{ item }}
              loop: "{{ problematic_packages | default([]) }}"
              when: problematic_packages is defined
              
            - name: Downgrade packages if possible
              apt:
                name: "{{ item }}={{ item.previous_version }}"
                state: present
                allow_downgrade: yes
              loop: "{{ packages_to_rollback | default([]) }}"
              when: packages_to_rollback is defined
              
        - name: Notify operations team of upgrade failure
          mail:
            to: "{{ ops_email | default('ops@example.com') }}"
            subject: "Package Upgrade Failed - {{ inventory_hostname }}"
            body: |
              Package upgrade validation failed on {{ inventory_hostname }}.
              
              Upgrade ID: {{ upgrade_id }}
              Upgrade Type: {{ upgrade_type }}
              Timestamp: {{ ansible_date_time.iso8601 }}
              
              Package integrity: {{ 'FAILED' if package_integrity_check.rc != 0 else 'OK' }}
              Broken packages: {{ 'DETECTED' if broken_packages_check.rc != 0 else 'NONE' }}
              Network connectivity: {{ 'FAILED' if network_connectivity_test.rc != 0 else 'OK' }}
              
              Please investigate and take corrective action.
          delegate_to: localhost
          when: notify_on_failure | default(true)
          
        - name: Fail the upgrade
          fail:
            msg: "Package upgrade validation failed on {{ inventory_hostname }}"

# Aggregate upgrade results
- name: Aggregate Upgrade Results
  hosts: localhost
  gather_facts: no
  run_once: true
  
  tasks:
    - name: Collect upgrade reports
      find:
        paths: /tmp
        patterns: "upgrade-report-{{ hostvars[groups['vpn_servers'][0]]['upgrade_id'] }}-*.txt"
      register: upgrade_reports
      
    - name: Generate infrastructure upgrade summary
      template:
        src: infrastructure-upgrade-summary.j2
        dest: "/tmp/infrastructure-upgrade-summary-{{ hostvars[groups['vpn_servers'][0]]['upgrade_id'] }}.txt"
      vars:
        total_servers: "{{ groups['vpn_servers'] | length }}"
        upgrade_type: "{{ hostvars[groups['vpn_servers'][0]]['upgrade_type'] }}"
        
    - name: Send upgrade completion notification
      mail:
        to: "{{ management_email | default('management@example.com') }}"
        subject: "VPN Infrastructure Upgrade Completed - {{ upgrade_type | title }}"
        body: |
          VPN infrastructure {{ upgrade_type }} upgrade completed.
          
          Total servers: {{ groups['vpn_servers'] | length }}
          Upgrade ID: {{ hostvars[groups['vpn_servers'][0]]['upgrade_id'] }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          
          Summary report: /tmp/infrastructure-upgrade-summary-{{ hostvars[groups['vpn_servers'][0]]['upgrade_id'] }}.txt
          
          All servers have been successfully upgraded and validated.
      when: send_completion_notification | default(true)