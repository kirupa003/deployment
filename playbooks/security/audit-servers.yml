---
# Security audit of VPN servers
# Usage: ansible-playbook playbooks/security/audit-servers.yml

- name: Security Audit
  hosts: vpn_servers
  become: true
  gather_facts: true

  vars:
    audit_report_dir: /tmp/security-audit
    audit_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

  tasks:
    - name: Create audit report directory
      ansible.builtin.file:
        path: "{{ audit_report_dir }}"
        state: directory
        mode: "0700"
      delegate_to: localhost
      become: false
      run_once: true
      tags: [setup]

    - name: Check for unauthorized SSH keys
      ansible.builtin.find:
        paths: /root/.ssh
        patterns: "authorized_keys*"
      register: root_ssh_keys
      tags: [ssh]

    - name: Check listening ports
      ansible.builtin.command:
        cmd: ss -tlnp
      register: listening_ports
      changed_when: false
      tags: [network]

    - name: Check running processes
      ansible.builtin.command:
        cmd: ps aux
      register: running_processes
      changed_when: false
      tags: [processes]

    - name: Check for setuid binaries
      ansible.builtin.command:
        cmd: find /usr -perm -4000 -type f
      register: setuid_binaries
      changed_when: false
      tags: [binaries]

    - name: Check last logins
      ansible.builtin.command:
        cmd: last -20
      register: last_logins
      changed_when: false
      tags: [auth]

    - name: Check failed login attempts
      ansible.builtin.command:
        cmd: grep "Failed password" /var/log/auth.log | tail -50
      register: failed_logins
      changed_when: false
      failed_when: false
      tags: [auth]

    - name: Check CrowdSec decisions
      ansible.builtin.command:
        cmd: cscli decisions list
      register: crowdsec_decisions
      changed_when: false
      tags: [crowdsec]

    - name: Check Fail2Ban status
      ansible.builtin.command:
        cmd: fail2ban-client status
      register: fail2ban_status
      changed_when: false
      tags: [fail2ban]

    - name: Check for world-writable files
      ansible.builtin.command:
        cmd: find /etc -perm -002 -type f
      register: world_writable
      changed_when: false
      tags: [permissions]

    - name: Generate audit report
      ansible.builtin.template:
        src: audit-report.j2
        dest: "{{ audit_report_dir }}/{{ inventory_hostname }}-{{ audit_timestamp }}.txt"
        mode: "0600"
      delegate_to: localhost
      become: false
      vars:
        report_data:
          hostname: "{{ inventory_hostname }}"
          timestamp: "{{ audit_timestamp }}"
          root_ssh_keys: "{{ root_ssh_keys.files | map(attribute='path') | list }}"
          listening_ports: "{{ listening_ports.stdout_lines }}"
          setuid_binaries: "{{ setuid_binaries.stdout_lines }}"
          last_logins: "{{ last_logins.stdout_lines }}"
          failed_logins: "{{ failed_logins.stdout_lines | default([]) }}"
          crowdsec_decisions: "{{ crowdsec_decisions.stdout_lines }}"
          fail2ban_status: "{{ fail2ban_status.stdout_lines }}"
          world_writable: "{{ world_writable.stdout_lines }}"
      tags: [report]

  post_tasks:
    - name: Display audit summary
      ansible.builtin.debug:
        msg: |
          Audit completed for {{ inventory_hostname }}
          - Root SSH keys found: {{ root_ssh_keys.files | length }}
          - Listening ports: {{ listening_ports.stdout_lines | length }}
          - SETUID binaries: {{ setuid_binaries.stdout_lines | length }}
          - Failed logins: {{ failed_logins.stdout_lines | default([]) | length }}
          - Active CrowdSec decisions: {{ crowdsec_decisions.stdout_lines | length - 1 }}
          - World-writable files: {{ world_writable.stdout_lines | length }}
      tags: [summary]
