VPN Server Health Validation Report
===================================

Server Information:
- Hostname: {{ inventory_hostname }}
- IP Address: {{ ansible_default_ipv4.address }}
- Check Time: {{ ansible_date_time.iso8601 }}
- Overall Status: {{ health_status }}

System Resource Status:
- CPU Usage: {{ cpu_usage.stdout }}% (Threshold: {{ cpu_threshold }}%)
- Memory Usage: {{ memory_usage.stdout }}% (Threshold: {{ memory_threshold }}%)
- Disk Usage: {{ disk_usage.stdout }}% (Threshold: {{ disk_threshold }}%)
- System Load: {{ system_load.stdout }}

Network Connectivity:
- Internet Access: {{ 'OK' if connectivity_check.results | selectattr('status', 'defined') | selectattr('status', 'equalto', 200) | list | length > 0 else 'FAILED' }}
- DNS Resolution: {{ dns_check.stdout }}
- VPN Ports: {{ port_check.results | selectattr('failed', 'equalto', false) | list | length }}/{{ port_check.results | length }} accessible

Service Status:
Critical Services:
{% for result in critical_service_status.results %}
- {{ result.item }}: {{ result.status.ActiveState | upper }}
{% endfor %}

VPN Services:
{% for result in vpn_service_status.results %}
{% if result.status is defined %}
- {{ result.item }}: {{ result.status.ActiveState | upper }}
{% endif %}
{% endfor %}

VPN Health Status:
{% if wg_interface_status is defined %}
- WireGuard Interface: {{ wg_interface_status.stdout }}
- Active WireGuard Peers: {{ wg_peer_count.stdout | default('0') }}
{% endif %}
{% if openvpn_status is defined %}
- OpenVPN Status: {{ openvpn_status.stdout }}
{% endif %}
- Connection Capacity: {{ capacity_usage.stdout }}% (Threshold: {{ connection_threshold }}%)

Security Status:
- Firewall: {{ firewall_status.stdout | upper }}
- Fail2Ban Jails: {{ fail2ban_jails.stdout | default('0') }} active
- CrowdSec Agent: {{ crowdsec_status.stdout | default('UNKNOWN') }}
- SSH Configuration: {{ ssh_config_status.stdout | upper }}

Issues Detected:
{% if all_issues | length > 0 %}
{% for issue in all_issues %}
- {{ issue }}
{% endfor %}
{% else %}
No issues detected - server is healthy
{% endif %}

{% if remediation_enabled and all_issues | length > 0 %}
Remediation Actions:
{% if service_restart_results is defined %}
Service Restarts:
{% for result in service_restart_results.results %}
- {{ result.item.item }}: {{ 'SUCCESS' if result is succeeded else 'FAILED' }}
{% endfor %}
{% endif %}

{% if vpn_restart_results is defined %}
VPN Service Restarts:
{% for result in vpn_restart_results.results %}
- {{ result.item.item }}: {{ 'SUCCESS' if result is succeeded else 'FAILED' }}
{% endfor %}
{% endif %}

{% if wg_fix_result is defined %}
- WireGuard Interface Fix: {{ 'SUCCESS' if wg_fix_result is succeeded else 'FAILED' }}
{% endif %}

{% if firewall_restart_result is defined %}
- Firewall Restart: {{ 'SUCCESS' if firewall_restart_result is succeeded else 'FAILED' }}
{% endif %}

{% if disk_cleanup_result is defined %}
- Disk Cleanup: {{ 'SUCCESS' if disk_cleanup_result is succeeded else 'FAILED' }}
{% endif %}

Post-Remediation Status:
{% if remediation_success is defined %}
- Service Recovery Rate: {{ remediation_success }}%
{% endif %}
{% endif %}

Recommendations:
{% if health_status == 'UNHEALTHY' %}
{% if resource_issues | length > 0 %}
- Monitor system resources and consider scaling up if consistently high
{% endif %}
{% if network_issues | length > 0 %}
- Check network connectivity and DNS configuration
{% endif %}
{% if service_issues | length > 0 %}
- Investigate service failures and check system logs
{% endif %}
{% if vpn_issues | length > 0 %}
- Review VPN configuration and client connections
{% endif %}
{% if security_issues | length > 0 %}
- Address security configuration issues immediately
{% endif %}
{% else %}
- Server is healthy - continue regular monitoring
- Consider performance optimization if approaching thresholds
{% endif %}

Next Actions:
1. {% if health_status == 'UNHEALTHY' %}Address identified issues{% else %}Continue monitoring{% endif %}
2. Review system logs for additional details
3. Update monitoring thresholds if needed
4. Schedule next health check

Report Generated: {{ ansible_date_time.iso8601 }}
Generated by: Ansible VPN Infrastructure Controller