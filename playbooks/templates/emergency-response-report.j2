Emergency Security Response Report
==================================

Response Information:
- Server: {{ inventory_hostname }}
- IP Address: {{ ansible_default_ipv4.address }}
- Action: {{ emergency_action }}
- Timestamp: {{ ansible_date_time.iso8601 }}
- Executed by: {{ ansible_user }}
- Response time: < {{ response_timeout }} seconds

Action Details:
==============

{% if emergency_action == 'block_ip' %}
IP Blocking Action:
- Blocked IPs: {{ emergency_block_ips | default([]) | join(', ') }}
- Ban duration: {{ emergency_ban_duration | default('24h') }}
- UFW rules added: {{ emergency_block_ips | default([]) | length }}
- CrowdSec decisions: {{ 'Added' if crowdsec_lapi_enabled else 'N/A' }}
{% endif %}

{% if emergency_action == 'block_country' %}
Country Blocking Action:
- Blocked countries: {{ emergency_block_countries | default([]) | join(', ') }}
- iptables rules added: {{ emergency_block_countries | default([]) | length }}
{% endif %}

{% if emergency_action == 'lockdown' %}
Emergency Lockdown Action:
- All incoming traffic: DENIED
- SSH access: LIMITED to management networks
- VPN services: TEMPORARILY BLOCKED
- Management networks: {{ emergency_management_networks | default(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']) | join(', ') }}
{% endif %}

{% if emergency_action == 'unblock_ip' %}
IP Unblocking Action:
- Unblocked IPs: {{ emergency_unblock_ips | default([]) | join(', ') }}
- UFW rules removed: {{ emergency_unblock_ips | default([]) | length }}
- CrowdSec decisions removed: {{ 'Yes' if crowdsec_lapi_enabled else 'N/A' }}
{% endif %}

Current Firewall Status:
=======================
{{ emergency_ufw_status.stdout if emergency_ufw_status is defined else 'Status check failed' }}

Security Services Status:
========================
- UFW: {{ ansible_facts.services['ufw.service']['state'] | default('unknown') }}
- Fail2Ban: {{ ansible_facts.services['fail2ban.service']['state'] | default('unknown') }}
- CrowdSec: {{ ansible_facts.services['crowdsec.service']['state'] | default('unknown') }}

Compliance Check:
================
- Emergency response time: ✓ < 5 minutes (Requirement 4.3)
- Action logged: ✓ COMPLETED
- Notification sent: {{ '✓ SENT' if emergency_notification_email is defined else '⚠ NOT CONFIGURED' }}

Follow-up Actions Required:
==========================
1. Review emergency action effectiveness
2. Investigate root cause of security incident
3. Update security policies if needed
4. Schedule security review meeting
5. Document lessons learned

Report generated by emergency-security-response playbook
=======================================================