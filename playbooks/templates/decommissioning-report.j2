VPN Server Decommissioning Report
=================================

Server Information:
- Hostname: {{ inventory_hostname }}
- IP Address: {{ ansible_default_ipv4.address }}
- Region: {{ server_region | default('unknown') }}
- Decommissioned: {{ ansible_date_time.iso8601 }}

Pre-Decommissioning Status:
- Active Connections: {{ total_connections }}
  - WireGuard Peers: {{ wg_connections.stdout | default('0') }}
  - OpenVPN Clients: {{ ovpn_connections.stdout | default('0') }}
- Drain Timeout: {{ drain_timeout }} seconds
- Force Disconnect: {{ force_disconnect }}

Connection Draining:
{% if remaining_connections is defined %}
- Final Connection Count: {{ remaining_connections.stdout | default('unknown') }}
- Draining Duration: {{ drain_check_interval * (max_drain_attempts - (remaining_connections.attempts | default(0))) }} seconds
- Natural Disconnect: {{ remaining_connections.stdout | int == 0 }}
{% else %}
- Connection draining not performed
{% endif %}

Services Stopped:
{% for service in ['wg-quick@wg0', 'openvpn@server', 'awg-quick@awg0', 'node_exporter', 'promtail', 'crowdsec', 'fail2ban'] %}
- {{ service }}
{% endfor %}

Configuration Backup:
- Backup Created: {{ backup_configs }}
{% if backup_configs %}
- Backup Location: {{ backup_location }}/{{ inventory_hostname }}
- Backed Up Files:
  - WireGuard Configuration
  - OpenVPN Configuration and PKI
  - Monitoring Configurations
  - Server Metadata
{% endif %}

Cleanup Actions:
- Data Cleanup Performed: {{ cleanup_data }}
{% if cleanup_data %}
- Removed Configurations:
  - /etc/wireguard/
  - /etc/openvpn/
  - /etc/amneziawg/
  - /etc/prometheus/
  - /etc/promtail/
  - /etc/crowdsec/
  - /etc/fail2ban/
- Removed Packages:
  - wireguard, wireguard-tools
  - openvpn, easy-rsa
  - prometheus-node-exporter
{% endif %}

Network Configuration:
- Firewall Rules: Reset to defaults
- IPTables: Flushed all custom rules
- VPN Interfaces: Removed

Final Validation:
{% if service_status is defined %}
Service Status Check:
{% for result in service_status.results %}
- {{ result.item }}: {{ result.stdout }}
{% endfor %}
{% endif %}

{% if port_check is defined %}
Port Check: {{ 'No VPN ports active' if 'no_vpn_ports' in port_check.stdout else 'VPN ports still active' }}
{% endif %}

Decommissioning Summary:
- Start Time: {{ ansible_date_time.iso8601 }}
- Connections Drained: {{ total_connections }}
- Services Stopped: All VPN and monitoring services
- Configurations: {{ 'Backed up and removed' if backup_configs and cleanup_data else 'Backed up only' if backup_configs else 'Removed only' if cleanup_data else 'Preserved' }}
- Status: DECOMMISSIONED

Recovery Information:
{% if backup_configs %}
To restore this server:
1. Locate backup at: {{ backup_location }}/{{ inventory_hostname }}
2. Run server provisioning playbook
3. Restore configurations from backup
4. Restart VPN services
{% else %}
No backup created - server cannot be easily restored
{% endif %}

Report Generated: {{ ansible_date_time.iso8601 }}
Generated by: Ansible VPN Infrastructure Controller