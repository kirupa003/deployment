Security Validation Report
=========================

Server Information:
- Hostname: {{ ansible_hostname }}
- IP Address: {{ ansible_default_ipv4.address }}
- OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
- Kernel: {{ ansible_kernel }}
- Validation Date: {{ ansible_date_time.iso8601 }}

Requirement 3.1 - SSH Hardening:
================================
- SSH Configuration Test: {{ 'PASS' if ssh_config_test.rc == 0 else 'FAIL' }}
- Root Login Disabled: {{ 'PASS' if not ssh_root_login_check.changed else 'FAIL' }}
- Password Auth Disabled: {{ 'PASS' if not ssh_password_auth_check.changed else 'FAIL' }}
- SSH Service Status: {{ ansible_facts.services['ssh.service']['state'] | upper }}
- SSH Service Enabled: {{ ansible_facts.services['ssh.service']['status'] | upper }}

Requirement 3.2 - UFW Firewall:
===============================
- UFW Status: {{ 'ACTIVE' if 'Status: active' in ufw_status_check.stdout else 'INACTIVE' }}
- Default Policy: {{ 'DENY' if 'Default: deny (incoming)' in ufw_status_check.stdout else 'ALLOW' }}
- SSH Rule Present: {{ 'YES' if (ansible_port | default('22') + '/tcp' in ufw_status_check.stdout or '22/tcp' in ufw_status_check.stdout) else 'NO' }}

UFW Rules Summary:
{{ ufw_status_check.stdout }}

Requirement 3.3 - Threat Protection:
====================================

Fail2Ban Status:
- Service State: {{ ansible_facts.services['fail2ban.service']['state'] | upper }}
- Service Enabled: {{ ansible_facts.services['fail2ban.service']['status'] | upper }}
- SSH Jail Active: {{ 'YES' if ('sshd' in fail2ban_status.stdout or 'ssh' in fail2ban_status.stdout) else 'NO' }}
{% if fail2ban_bantime is defined and fail2ban_bantime.rc == 0 %}
- SSH Ban Time: {{ fail2ban_bantime.stdout }} seconds
{% endif %}

CrowdSec Status:
- Service State: {{ ansible_facts.services['crowdsec.service']['state'] | upper }}
- Service Enabled: {{ ansible_facts.services['crowdsec.service']['status'] | upper }}
- Metrics Endpoint: {{ 'ACCESSIBLE' if crowdsec_prometheus_enabled else 'DISABLED' }}
{% if crowdsec_lapi_enabled | default(false) %}
- LAPI Connectivity: VERIFIED
{% endif %}

Requirement 3.5 - Security Updates:
===================================
- Unattended Upgrades: {{ 'CONFIGURED' if unattended_upgrades_config.stat.exists else 'NOT CONFIGURED' }}
{% if security_updates_available is defined %}
- Available Updates: {{ security_updates_available.stdout_lines | length }} packages
{% endif %}

Network Security:
=================
Open Ports:
{% for line in open_ports.stdout_lines %}
{{ line }}
{% endfor %}

Kernel Security Parameters:
{% for item in sysctl_check.results %}
- {{ item.item.name }}: {{ 'CONFIGURED' if not item.changed else 'NEEDS ATTENTION' }}
{% endfor %}

Compliance Summary:
==================
- Requirement 3.1 (SSH Hardening): {{ '✓ COMPLIANT' if ssh_config_test.rc == 0 and not ssh_root_login_check.changed and not ssh_password_auth_check.changed else '✗ NON-COMPLIANT' }}
- Requirement 3.2 (UFW Firewall): {{ '✓ COMPLIANT' if 'Status: active' in ufw_status_check.stdout and 'Default: deny (incoming)' in ufw_status_check.stdout else '✗ NON-COMPLIANT' }}
- Requirement 3.3 (Threat Protection): {{ '✓ COMPLIANT' if ansible_facts.services['fail2ban.service']['state'] == 'running' and ansible_facts.services['crowdsec.service']['state'] == 'running' else '✗ NON-COMPLIANT' }}
- Requirement 3.5 (Security Updates): {{ '✓ COMPLIANT' if unattended_upgrades_config.stat.exists else '⚠ ATTENTION NEEDED' }}

Overall Security Posture: {{ 'SECURE' if (ssh_config_test.rc == 0 and 'Status: active' in ufw_status_check.stdout and ansible_facts.services['fail2ban.service']['state'] == 'running' and ansible_facts.services['crowdsec.service']['state'] == 'running') else 'REQUIRES ATTENTION' }}

Recommendations:
===============
{% if ssh_config_test.rc != 0 %}
- Fix SSH configuration errors
{% endif %}
{% if 'Status: active' not in ufw_status_check.stdout %}
- Enable UFW firewall
{% endif %}
{% if ansible_facts.services['fail2ban.service']['state'] != 'running' %}
- Start and enable Fail2Ban service
{% endif %}
{% if ansible_facts.services['crowdsec.service']['state'] != 'running' %}
- Start and enable CrowdSec service
{% endif %}
{% if not unattended_upgrades_config.stat.exists %}
- Configure automatic security updates
{% endif %}

Report generated by security-validation playbook
================================================