---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'vpn-infrastructure'
        region: 'multi-region'

    rule_files:
      - "/etc/prometheus/rules/*.yml"

    scrape_configs:
      # VPN Server Node Exporters (30 servers across 3 regions)
      - job_name: 'vpn-servers-node-exporter'
        static_configs:
          # Europe Region (12 servers)
          - targets:
            - '185.199.108.153:9100'  # eu-wg-001
            - '185.199.109.154:9100'  # eu-wg-002
            - '185.199.110.155:9100'  # eu-wg-003
            - '185.199.111.156:9100'  # eu-wg-004
            - '185.199.112.157:9100'  # eu-wg-005
            - '185.199.113.158:9100'  # eu-wg-006
            - '185.199.114.159:9100'  # eu-wg-007
            - '185.199.115.160:9100'  # eu-wg-008
            - '185.199.116.161:9100'  # eu-wg-009
            - '185.199.117.162:9100'  # eu-wg-010
            - '185.199.118.163:9100'  # eu-wg-011
            - '185.199.119.164:9100'  # eu-wg-012
            labels:
              region: 'europe'
              service: 'vpn-server'
          # North America Region (10 servers)
          - targets:
            - '192.241.128.100:9100'  # na-wg-001
            - '192.241.129.101:9100'  # na-wg-002
            - '192.241.130.102:9100'  # na-wg-003
            - '192.241.131.103:9100'  # na-wg-004
            - '192.241.132.104:9100'  # na-wg-005
            - '192.241.133.105:9100'  # na-wg-006
            - '192.241.134.106:9100'  # na-wg-007
            - '192.241.135.107:9100'  # na-wg-008
            - '192.241.136.108:9100'  # na-wg-009
            - '192.241.137.109:9100'  # na-wg-010
            labels:
              region: 'north_america'
              service: 'vpn-server'
          # Asia Pacific Region (8 servers)
          - targets:
            - '203.175.10.200:9100'   # ap-wg-001
            - '203.175.11.201:9100'   # ap-wg-002
            - '203.175.12.202:9100'   # ap-wg-003
            - '203.175.13.203:9100'   # ap-wg-004
            - '203.175.14.204:9100'   # ap-wg-005
            - '203.175.15.205:9100'   # ap-wg-006
            - '203.175.16.206:9100'   # ap-wg-007
            - '203.175.17.207:9100'   # ap-wg-008
            labels:
              region: 'asia_pacific'
              service: 'vpn-server'

      # WireGuard Exporters
      - job_name: 'wireguard-exporter'
        static_configs:
          # Europe WireGuard servers
          - targets:
            - '185.199.108.153:9586'  # eu-wg-001
            - '185.199.109.154:9586'  # eu-wg-002
            - '185.199.110.155:9586'  # eu-wg-003
            - '185.199.112.157:9586'  # eu-wg-005
            - '185.199.113.158:9586'  # eu-wg-006
            - '185.199.114.159:9586'  # eu-wg-007
            - '185.199.115.160:9586'  # eu-wg-008
            - '185.199.117.162:9586'  # eu-wg-010
            - '185.199.118.163:9586'  # eu-wg-011
            - '185.199.119.164:9586'  # eu-wg-012
            labels:
              region: 'europe'
              service: 'wireguard'
          # North America WireGuard servers
          - targets:
            - '192.241.128.100:9586'  # na-wg-001
            - '192.241.129.101:9586'  # na-wg-002
            - '192.241.130.102:9586'  # na-wg-003
            - '192.241.132.104:9586'  # na-wg-005
            - '192.241.133.105:9586'  # na-wg-006
            - '192.241.134.106:9586'  # na-wg-007
            - '192.241.135.107:9586'  # na-wg-008
            - '192.241.137.109:9586'  # na-wg-010
            labels:
              region: 'north_america'
              service: 'wireguard'
          # Asia Pacific WireGuard servers
          - targets:
            - '203.175.10.200:9586'   # ap-wg-001
            - '203.175.11.201:9586'   # ap-wg-002
            - '203.175.12.202:9586'   # ap-wg-003
            - '203.175.14.204:9586'   # ap-wg-005
            - '203.175.15.205:9586'   # ap-wg-006
            - '203.175.16.206:9586'   # ap-wg-007
            - '203.175.17.207:9586'   # ap-wg-008
            labels:
              region: 'asia_pacific'
              service: 'wireguard'

      # OpenVPN Exporters
      - job_name: 'openvpn-exporter'
        static_configs:
          # Europe OpenVPN servers
          - targets:
            - '185.199.109.154:9176'  # eu-wg-002
            - '185.199.111.156:9176'  # eu-wg-004
            - '185.199.112.157:9176'  # eu-wg-005
            - '185.199.114.159:9176'  # eu-wg-007
            - '185.199.116.161:9176'  # eu-wg-009
            - '185.199.117.162:9176'  # eu-wg-010
            - '185.199.119.164:9176'  # eu-wg-012
            labels:
              region: 'europe'
              service: 'openvpn'
          # North America OpenVPN servers
          - targets:
            - '192.241.129.101:9176'  # na-wg-002
            - '192.241.131.103:9176'  # na-wg-004
            - '192.241.132.104:9176'  # na-wg-005
            - '192.241.134.106:9176'  # na-wg-007
            - '192.241.136.108:9176'  # na-wg-009
            - '192.241.137.109:9176'  # na-wg-010
            labels:
              region: 'north_america'
              service: 'openvpn'
          # Asia Pacific OpenVPN servers
          - targets:
            - '203.175.11.201:9176'   # ap-wg-002
            - '203.175.13.203:9176'   # ap-wg-004
            - '203.175.14.204:9176'   # ap-wg-005
            - '203.175.16.206:9176'   # ap-wg-007
            labels:
              region: 'asia_pacific'
              service: 'openvpn'

      # Kubernetes cluster monitoring
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https

      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
        - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)

      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093