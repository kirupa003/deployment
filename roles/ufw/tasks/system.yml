---
- name: Ensure system is prepared for UFW
  block:
    - name: Update package cache
      apt:
        update_cache: true
        cache_valid_time: 3600
      become: true

    - name: Backup existing UFW configuration
      copy:
        src: "{{ item }}"
        dest: "{{ item }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
        owner: root
        group: root
        mode: preserve
      become: true
      loop:
        - /etc/ufw/ufw.conf
        - /etc/default/ufw
      failed_when: false
      when: ufw_backup

    - name: Ensure UFW directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      become: true
      loop:
        - /etc/ufw
        - /etc/ufw/applications.d
        - /var/log/ufw

    - name: Check if UFW is currently active
      command: ufw status
      register: ufw_current_status
      changed_when: false
      failed_when: false
      become: true

    - name: Display current UFW status
      debug:
        var: ufw_current_status.stdout_lines

  tags:
    - ufw
    - system