---
# Centralized VPN Configuration Database (PostgreSQL)

- name: Install PostgreSQL
  ansible.builtin.apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
      - libpq-dev
    state: present
    update_cache: true
  tags: [vpn_config_db, postgresql]

- name: Start and enable PostgreSQL
  ansible.builtin.systemd:
    name: postgresql
    state: started
    enabled: true
  tags: [vpn_config_db, postgresql]

- name: Create SSL directory
  ansible.builtin.file:
    path: /etc/postgresql/ssl
    state: directory
    owner: postgres
    group: postgres
    mode: "0700"
  when: vpn_db_ssl_enabled
  tags: [vpn_config_db, ssl]

- name: Generate self-signed SSL certificate
  ansible.builtin.command:
    cmd: >
      openssl req -new -x509 -days 3650 -nodes
      -out {{ vpn_db_ssl_cert }}
      -keyout {{ vpn_db_ssl_key }}
      -subj "/CN={{ inventory_hostname }}/O=VPN Config DB"
    creates: "{{ vpn_db_ssl_cert }}"
  become_user: postgres
  when: vpn_db_ssl_enabled
  tags: [vpn_config_db, ssl]

- name: Configure PostgreSQL
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: /etc/postgresql/{{ postgresql_version | default('14') }}/main/postgresql.conf
    owner: postgres
    group: postgres
    mode: "0644"
  notify: Restart PostgreSQL
  tags: [vpn_config_db, config]

- name: Configure PostgreSQL HBA
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: /etc/postgresql/{{ postgresql_version | default('14') }}/main/pg_hba.conf
    owner: postgres
    group: postgres
    mode: "0640"
  notify: Restart PostgreSQL
  tags: [vpn_config_db, config]

- name: Flush handlers to restart PostgreSQL
  ansible.builtin.meta: flush_handlers

- name: Create VPN database
  become_user: postgres
  community.postgresql.postgresql_db:
    name: "{{ vpn_db_name }}"
    encoding: UTF8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
  tags: [vpn_config_db, database]

- name: Create database admin user
  become_user: postgres
  community.postgresql.postgresql_user:
    name: "{{ vpn_db_user }}"
    password: "{{ vpn_db_password }}"
    db: "{{ vpn_db_name }}"
    priv: ALL
    role_attr_flags: SUPERUSER,CREATEDB
  tags: [vpn_config_db, database]

- name: Create API user
  become_user: postgres
  community.postgresql.postgresql_user:
    name: "{{ vpn_db_api_user }}"
    password: "{{ vpn_db_api_password }}"
    db: "{{ vpn_db_name }}"
  tags: [vpn_config_db, database]

- name: Create readonly user
  become_user: postgres
  community.postgresql.postgresql_user:
    name: "{{ vpn_db_readonly_user }}"
    password: "{{ vpn_db_readonly_password }}"
    db: "{{ vpn_db_name }}"
  tags: [vpn_config_db, database]

- name: Deploy database schema
  ansible.builtin.template:
    src: init-schema.sql.j2
    dest: /tmp/vpn-config-schema.sql
    mode: "0600"
  tags: [vpn_config_db, schema]

- name: Initialize database schema
  become_user: postgres
  community.postgresql.postgresql_query:
    db: "{{ vpn_db_name }}"
    path_to_script: /tmp/vpn-config-schema.sql
  register: schema_result
  changed_when: false
  tags: [vpn_config_db, schema]

- name: Remove schema file
  ansible.builtin.file:
    path: /tmp/vpn-config-schema.sql
    state: absent
  tags: [vpn_config_db, schema]

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ vpn_db_backup_path }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0750"
  when: vpn_db_backup_enabled
  tags: [vpn_config_db, backup]

- name: Deploy backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: /usr/local/bin/vpn-db-backup.sh
    mode: "0750"
    owner: postgres
    group: postgres
  when: vpn_db_backup_enabled
  tags: [vpn_config_db, backup]

- name: Schedule daily backups
  ansible.builtin.cron:
    name: "VPN Config DB Backup"
    user: postgres
    hour: "2"
    minute: "0"
    job: "/usr/local/bin/vpn-db-backup.sh"
  when: vpn_db_backup_enabled
  tags: [vpn_config_db, backup]

- name: Configure firewall for PostgreSQL
  community.general.ufw:
    rule: allow
    port: "{{ vpn_db_port | string }}"
    proto: tcp
    from_ip: "{{ item }}"
  loop: "{{ groups['wireguard_servers'] | default([]) + groups['amneziawg_servers'] | default([]) + groups['openvpn_servers'] | default([]) + ['10.0.0.0/8'] }}"
  tags: [vpn_config_db, firewall]

- name: Display database info
  ansible.builtin.debug:
    msg: |
      =====================================================
      VPN Configuration Database Deployed!
      =====================================================

      Connection Details:
      - Host: {{ ansible_host }}
      - Port: {{ vpn_db_port }}
      - Database: {{ vpn_db_name }}
      - Admin User: {{ vpn_db_user }}
      - API User: {{ vpn_db_api_user }}

      Connection String (for VPN gateways):
      postgresql://{{ vpn_db_api_user }}:****@{{ ansible_host }}:{{ vpn_db_port }}/{{ vpn_db_name }}

      Tables:
      - vpn_servers: VPN gateway registration
      - vpn_peers: Client configurations
      - ip_pools: IP address allocation
      - audit_log: Change tracking

      Backup Location: {{ vpn_db_backup_path }}
      =====================================================
  tags: [vpn_config_db, verify]
