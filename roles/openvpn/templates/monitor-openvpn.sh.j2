#!/bin/bash
# OpenVPN Service Monitoring Script
# Generated by Ansible

LOG_FILE="{{ openvpn_log_dir }}/monitor.log"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check UDP service
{% if openvpn_protocol in ['udp', 'both'] %}
if ! systemctl is-active --quiet {{ _openvpn_service_udp }}; then
    log_message "ERROR: OpenVPN UDP service is down, attempting restart"
    
    if systemctl restart {{ _openvpn_service_udp }}; then
        log_message "INFO: Successfully restarted OpenVPN UDP service"
    else
        log_message "ERROR: Failed to restart OpenVPN UDP service"
        echo "OpenVPN UDP service failed to restart on $(hostname)" | \
            logger -t openvpn-monitor -p daemon.error
    fi
else
    log_message "INFO: OpenVPN UDP service is running"
fi
{% endif %}

# Check TCP service
{% if openvpn_protocol in ['tcp', 'both'] %}
if ! systemctl is-active --quiet {{ _openvpn_service_tcp }}; then
    log_message "ERROR: OpenVPN TCP service is down, attempting restart"
    
    if systemctl restart {{ _openvpn_service_tcp }}; then
        log_message "INFO: Successfully restarted OpenVPN TCP service"
    else
        log_message "ERROR: Failed to restart OpenVPN TCP service"
        echo "OpenVPN TCP service failed to restart on $(hostname)" | \
            logger -t openvpn-monitor -p daemon.error
    fi
else
    log_message "INFO: OpenVPN TCP service is running"
fi
{% endif %}

# Check management interface
{% if openvpn_management_enabled %}
if ! echo "status" | nc -w 5 {{ openvpn_management_ip }} {{ openvpn_management_port }} &>/dev/null; then
    log_message "WARNING: OpenVPN management interface is not responding"
fi
{% endif %}