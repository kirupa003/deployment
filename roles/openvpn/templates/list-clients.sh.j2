#!/bin/bash
# OpenVPN Client Listing Script
# Generated by Ansible

CLIENT_CONFIG_DIR="{{ openvpn_client_config_dir }}"

echo "OpenVPN Client Status Report"
echo "============================"
echo "Generated: $(date)"
echo ""

# Show service status
{% if openvpn_protocol in ['udp', 'both'] %}
echo "UDP Service Status:"
systemctl status {{ _openvpn_service_udp }} --no-pager -l | head -3
echo ""
{% endif %}

{% if openvpn_protocol in ['tcp', 'both'] %}
echo "TCP Service Status:"
systemctl status {{ _openvpn_service_tcp }} --no-pager -l | head -3
echo ""
{% endif %}

# Show client database
if [[ -f "$CLIENT_CONFIG_DIR/clients.db" ]]; then
    echo "Client Database:"
    echo "Name,Serial,Created,Expires,Status"
    echo "-----------------------------------"
    grep -v "^#" "$CLIENT_CONFIG_DIR/clients.db" | while IFS=',' read -r name serial created expires status; do
        echo "$name,$serial,$created,$expires,$status"
    done
    echo ""
    
    # Count clients by status
    ACTIVE_COUNT=$(grep ",active$" "$CLIENT_CONFIG_DIR/clients.db" | wc -l)
    REMOVED_COUNT=$(grep ",removed$" "$CLIENT_CONFIG_DIR/clients.db" | wc -l)
    REVOKED_COUNT=$(grep ",revoked$" "$CLIENT_CONFIG_DIR/clients.db" | wc -l)
    TOTAL_COUNT=$((ACTIVE_COUNT + REMOVED_COUNT + REVOKED_COUNT))
    
    echo "Summary:"
    echo "  Active clients: $ACTIVE_COUNT"
    echo "  Removed clients: $REMOVED_COUNT"
    echo "  Revoked clients: $REVOKED_COUNT"
    echo "  Total clients: $TOTAL_COUNT"
else
    echo "No client database found"
fi

echo ""
echo "Current Connections:"
{% if openvpn_management_enabled %}
echo "status" | nc {{ openvpn_management_ip }} {{ openvpn_management_port }} 2>/dev/null | grep "CLIENT_LIST" | cut -d',' -f2,3,4 | while IFS=',' read -r name ip port; do
    echo "  $name ($ip:$port)"
done
{% else %}
echo "Management interface disabled - cannot show current connections"
{% endif %}