#!/bin/bash
# OpenVPN Client Removal Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ openvpn_client_config_dir }}"
EASYRSA_DIR="{{ openvpn_ca_dir }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Check if client exists
if ! grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' not found"
    exit 1
fi

# Move client configuration to revoked
if [[ -f "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" ]]; then
    mv "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" "$CLIENT_CONFIG_DIR/revoked/"
fi

# Update client database
sed -i "s/^$CLIENT_NAME,\(.*\),active$/$CLIENT_NAME,\1,removed/" "$CLIENT_CONFIG_DIR/clients.db"

echo "Client '$CLIENT_NAME' removed successfully!"
echo "Configuration moved to: $CLIENT_CONFIG_DIR/revoked/$CLIENT_NAME.ovpn"
echo "Note: Certificate is still valid. Use 'ovpn-revoke-client $CLIENT_NAME' to revoke the certificate."