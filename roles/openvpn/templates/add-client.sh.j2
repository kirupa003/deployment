#!/bin/bash
# OpenVPN Client Addition Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ openvpn_client_config_dir }}"
EASYRSA_DIR="{{ openvpn_ca_dir }}"
PKI_DIR="{{ openvpn_pki_dir }}"
TEMPLATE_DIR="{{ openvpn_client_template_dir }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Validate client name
if [[ ! "$CLIENT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: Client name can only contain letters, numbers, hyphens, and underscores"
    exit 1
fi

# Check if client already exists
if grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' already exists"
    exit 1
fi

cd "$EASYRSA_DIR"

# Generate client certificate request
./easyrsa gen-req "$CLIENT_NAME" nopass
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to generate certificate request for $CLIENT_NAME"
    exit 1
fi

# Sign client certificate
./easyrsa sign-req client "$CLIENT_NAME"
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to sign certificate for $CLIENT_NAME"
    exit 1
fi

# Get certificate serial number
SERIAL=$(openssl x509 -in "$PKI_DIR/issued/$CLIENT_NAME.crt" -noout -serial | cut -d= -f2)

# Read certificate files
CA_CERT=$(cat "$PKI_DIR/ca.crt")
CLIENT_CERT=$(openssl x509 -in "$PKI_DIR/issued/$CLIENT_NAME.crt" -noout -text -certopt no_header,no_version,no_serial,no_signame,no_validity,no_subject,no_issuer,no_pubkey,no_sigdump,no_aux && cat "$PKI_DIR/issued/$CLIENT_NAME.crt")
CLIENT_KEY=$(cat "$PKI_DIR/private/$CLIENT_NAME.key")

{% if openvpn_tls_auth %}
TLS_AUTH_KEY=$(cat "$PKI_DIR/ta.key")
{% endif %}

{% if openvpn_tls_crypt %}
TLS_CRYPT_KEY=$(cat "$PKI_DIR/tls-crypt.key")
{% endif %}

# Generate client configuration
cat > "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
client
dev tun
proto {{ openvpn_protocol if openvpn_protocol != 'both' else 'udp' }}
remote {{ ansible_default_ipv4.address }} {{ openvpn_port_udp if openvpn_protocol != 'tcp' else openvpn_port_tcp }}
{% if openvpn_protocol == 'both' %}
remote {{ ansible_default_ipv4.address }} {{ openvpn_port_tcp }} tcp
{% endif %}
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher {{ openvpn_cipher }}
auth {{ openvpn_auth }}
tls-version-min {{ openvpn_tls_version_min }}
verb 3
mute 20

<ca>
EOF

echo "$CA_CERT" >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"

cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
</ca>

<cert>
EOF

echo "$CLIENT_CERT" >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"

cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
</cert>

<key>
EOF

echo "$CLIENT_KEY" >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"

cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
</key>
EOF

{% if openvpn_tls_auth %}
cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'

<tls-auth>
EOF

echo "$TLS_AUTH_KEY" >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"

cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
</tls-auth>
key-direction 1
EOF
{% endif %}

{% if openvpn_tls_crypt %}
cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'

<tls-crypt>
EOF

echo "$TLS_CRYPT_KEY" >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"

cat >> "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" << 'EOF'
</tls-crypt>
EOF
{% endif %}

# Add client to database
echo "$CLIENT_NAME,$SERIAL,$(date -Iseconds),$(date -d '+{{ openvpn_cert_expire }} days' -Iseconds),active" >> "$CLIENT_CONFIG_DIR/clients.db"

echo "Client '$CLIENT_NAME' added successfully!"
echo "Configuration: $CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn"
echo "Serial Number: $SERIAL"