#!/bin/bash
# OpenVPN Client Certificate Revocation Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ openvpn_client_config_dir }}"
EASYRSA_DIR="{{ openvpn_ca_dir }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Check if client exists
if ! grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' not found"
    exit 1
fi

cd "$EASYRSA_DIR"

# Revoke client certificate
./easyrsa revoke "$CLIENT_NAME"
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to revoke certificate for $CLIENT_NAME"
    exit 1
fi

# Generate new CRL
./easyrsa gen-crl
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to generate new CRL"
    exit 1
fi

# Move client configuration to revoked if still active
if [[ -f "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" ]]; then
    mv "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.ovpn" "$CLIENT_CONFIG_DIR/revoked/"
fi

# Update client database
sed -i "s/^$CLIENT_NAME,\(.*\),\(active\|removed\)$/$CLIENT_NAME,\1,revoked/" "$CLIENT_CONFIG_DIR/clients.db"

# Restart OpenVPN services to reload CRL
{% if openvpn_protocol in ['udp', 'both'] %}
systemctl reload {{ _openvpn_service_udp }} || true
{% endif %}
{% if openvpn_protocol in ['tcp', 'both'] %}
systemctl reload {{ _openvpn_service_tcp }} || true
{% endif %}

echo "Client '$CLIENT_NAME' certificate revoked successfully!"
echo "CRL updated and OpenVPN services reloaded"