# OpenVPN Server Configuration ({{ openvpn_current_protocol | upper }})
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

# Network settings
port {{ openvpn_current_port }}
proto {{ openvpn_current_protocol }}
dev {{ openvpn_dev }}
topology {{ openvpn_topology }}

# Certificate and key files
ca {{ openvpn_pki_dir }}/ca.crt
cert {{ openvpn_pki_dir }}/issued/{{ openvpn_server_name }}.crt
key {{ openvpn_pki_dir }}/private/{{ openvpn_server_name }}.key
dh {{ openvpn_pki_dir }}/dh.pem

# TLS security
{% if openvpn_tls_auth %}
tls-auth {{ openvpn_pki_dir }}/ta.key 0
{% endif %}
{% if openvpn_tls_crypt %}
tls-crypt {{ openvpn_pki_dir }}/tls-crypt.key
{% endif %}
tls-version-min {{ openvpn_tls_version_min }}

# Encryption and authentication
cipher {{ openvpn_cipher }}
auth {{ openvpn_auth }}

# Network configuration
server {{ openvpn_server_network }} {{ openvpn_server_netmask }}
ifconfig-pool-persist {{ openvpn_log_dir }}/ipp-{{ openvpn_current_protocol }}.txt

# Client configuration directory
client-config-dir {{ openvpn_ccd_dir }}

# Push routes and DNS to clients
{% if openvpn_redirect_gateway %}
push "redirect-gateway def1 bypass-dhcp"
{% endif %}
{% if openvpn_push_dns %}
{% for dns in openvpn_dns_servers %}
push "dhcp-option DNS {{ dns }}"
{% endfor %}
{% endif %}

# Client settings
keepalive 10 120
max-clients {{ openvpn_max_clients }}

# Performance tuning
sndbuf {{ openvpn_sndbuf }}
rcvbuf {{ openvpn_rcvbuf }}
push "sndbuf {{ openvpn_push_sndbuf }}"
push "rcvbuf {{ openvpn_push_rcvbuf }}"

# MTU settings
{% if openvpn_current_protocol == 'udp' %}
mtu-disc yes
{% endif %}
tun-mtu {{ openvpn_mtu }}
{% if openvpn_fragment is defined and openvpn_current_protocol == 'udp' %}
fragment {{ openvpn_fragment }}
{% endif %}
{% if openvpn_mssfix %}
mssfix
{% endif %}

# Security settings
user nobody
group nogroup
persist-key
persist-tun

# Certificate Revocation List
{% if openvpn_crl_enabled %}
crl-verify {{ openvpn_pki_dir }}/crl.pem
{% endif %}

# Management interface
{% if openvpn_management_enabled %}
management {{ openvpn_management_ip }} {{ openvpn_management_port }}
{% endif %}

# Logging
status {{ openvpn_status_log }}-{{ openvpn_current_protocol }}
log-append {{ openvpn_log_file }}-{{ openvpn_current_protocol }}
verb {{ openvpn_log_level }}
mute 20

# Explicit exit notify for UDP
{% if openvpn_current_protocol == 'udp' %}
explicit-exit-notify 1
{% endif %}