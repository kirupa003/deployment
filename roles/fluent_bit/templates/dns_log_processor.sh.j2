#!/bin/bash
# Fluent Bit DNS Log Processing Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
LOG_DIR="{{ fluent_bit_log_dir }}"
DATA_DIR="{{ fluent_bit_data_dir }}"
CONFIG_DIR="{{ fluent_bit_config_dir }}"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_DIR/processor.log"
}

# Function to check DNS log sources
check_dns_sources() {
    local sources_found=0
    
    # Check for CoreDNS logs
    if [[ -f /var/log/coredns/coredns.log ]]; then
        log_message "Found CoreDNS logs"
        sources_found=$((sources_found + 1))
    fi
    
    # Check for dnsmasq logs
    if [[ -f /var/log/dnsmasq.log ]] || grep -q "dnsmasq" /var/log/syslog 2>/dev/null; then
        log_message "Found dnsmasq logs"
        sources_found=$((sources_found + 1))
    fi
    
    # Check for unbound logs
    if [[ -f /var/log/unbound/unbound.log ]]; then
        log_message "Found unbound logs"
        sources_found=$((sources_found + 1))
    fi
    
    # Check for BIND9 logs
    if [[ -f /var/log/named/queries.log ]]; then
        log_message "Found BIND9 logs"
        sources_found=$((sources_found + 1))
    fi
    
    log_message "Total DNS log sources found: $sources_found"
    return $sources_found
}

# Function to process DNS query statistics
process_dns_stats() {
    local stats_file="$DATA_DIR/dns_stats.json"
    local temp_file=$(mktemp)
    
    {
        echo "{"
        echo "  \"timestamp\": \"$(date -Iseconds)\","
        echo "  \"hostname\": \"{{ ansible_hostname }}\","
        echo "  \"region\": \"{{ ansible_ec2_placement_region | default('unknown') }}\","
        
        # Query counts by type
        echo "  \"query_counts\": {"
        
        # Count A records
        local a_count
        a_count=$(grep -c " A " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        echo "    \"A\": $a_count,"
        
        # Count AAAA records
        local aaaa_count
        aaaa_count=$(grep -c " AAAA " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        echo "    \"AAAA\": $aaaa_count,"
        
        # Count PTR records
        local ptr_count
        ptr_count=$(grep -c " PTR " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        echo "    \"PTR\": $ptr_count,"
        
        # Count MX records
        local mx_count
        mx_count=$(grep -c " MX " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        echo "    \"MX\": $mx_count"
        
        echo "  },"
        
        # Response codes
        echo "  \"response_codes\": {"
        
        local noerror_count nxdomain_count servfail_count
        noerror_count=$(grep -c " NOERROR " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        nxdomain_count=$(grep -c " NXDOMAIN " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        servfail_count=$(grep -c " SERVFAIL " /var/log/coredns/coredns.log 2>/dev/null || echo "0")
        
        echo "    \"NOERROR\": $noerror_count,"
        echo "    \"NXDOMAIN\": $nxdomain_count,"
        echo "    \"SERVFAIL\": $servfail_count"
        
        echo "  },"
        
        # Top queried domains (last 1000 queries)
        echo "  \"top_domains\": ["
        if [[ -f /var/log/coredns/coredns.log ]]; then
            tail -1000 /var/log/coredns/coredns.log | \
            grep -oE '"[A-Za-z0-9.-]+\.[A-Za-z]{2,}"' | \
            sort | uniq -c | sort -nr | head -10 | \
            while read -r count domain; do
                domain=$(echo "$domain" | tr -d '"')
                echo "    {\"domain\": \"$domain\", \"count\": $count},"
            done | sed '$ s/,$//'
        fi
        echo "  ],"
        
        # Fluent Bit status
        local fluent_bit_status
        if systemctl is-active --quiet fluent-bit; then
            fluent_bit_status="active"
        else
            fluent_bit_status="inactive"
        fi
        echo "  \"fluent_bit_status\": \"$fluent_bit_status\","
        
        # Log file sizes
        local total_log_size
        total_log_size=$(find /var/log -name "*.log" -type f -exec du -cb {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        echo "  \"total_log_size_bytes\": $total_log_size"
        
        echo "}"
    } > "$temp_file"
    
    # Validate JSON and move to final location
    if python3 -m json.tool "$temp_file" > /dev/null 2>&1; then
        mv "$temp_file" "$stats_file"
        chown {{ fluent_bit_user }}:{{ fluent_bit_group }} "$stats_file" 2>/dev/null || true
        chmod 644 "$stats_file" 2>/dev/null || true
        log_message "DNS statistics updated successfully"
    else
        log_message "ERROR: Invalid JSON generated for DNS statistics"
        rm -f "$temp_file"
        return 1
    fi
}

# Function to check Fluent Bit health
check_fluent_bit_health() {
    # Check service status
    if ! systemctl is-active --quiet fluent-bit; then
        log_message "WARNING: Fluent Bit service is not running"
        return 1
    fi
    
    # Check HTTP API
    if ! curl -s "http://{{ fluent_bit_listen_address }}:{{ fluent_bit_port }}/api/v1/health" > /dev/null; then
        log_message "WARNING: Fluent Bit HTTP API is not responding"
        return 1
    fi
    
    # Check configuration
    if ! /usr/bin/fluent-bit --config="$CONFIG_DIR/fluent-bit.conf" --dry-run > /dev/null 2>&1; then
        log_message "WARNING: Fluent Bit configuration is invalid"
        return 1
    fi
    
    log_message "Fluent Bit health check passed"
    return 0
}

# Function to rotate large log files
rotate_large_logs() {
    local max_size_mb=500
    local max_size_bytes=$((max_size_mb * 1024 * 1024))
    
    find /var/log -name "*.log" -type f -size +${max_size_mb}M 2>/dev/null | while read -r logfile; do
        local size
        size=$(stat -c%s "$logfile" 2>/dev/null || echo "0")
        
        if [[ $size -gt $max_size_bytes ]]; then
            log_message "Rotating large log file: $logfile (${size} bytes)"
            
            # Create backup
            cp "$logfile" "${logfile}.$(date +%Y%m%d_%H%M%S)"
            
            # Truncate original
            > "$logfile"
            
            # Restart fluent-bit to reopen file handles
            systemctl reload fluent-bit || true
        fi
    done
}

# Main execution
main() {
    log_message "Starting DNS log processing"
    
    # Ensure directories exist
    mkdir -p "$LOG_DIR" "$DATA_DIR"
    
    # Check DNS sources
    if ! check_dns_sources; then
        log_message "WARNING: No DNS log sources found"
    fi
    
    # Process DNS statistics
    process_dns_stats || log_message "Failed to process DNS statistics"
    
    # Health check
    check_fluent_bit_health || log_message "Fluent Bit health check failed"
    
    # Rotate large logs
    rotate_large_logs
    
    # Set proper permissions
    chown -R {{ fluent_bit_user }}:{{ fluent_bit_group }} "$DATA_DIR" 2>/dev/null || true
    
    log_message "DNS log processing completed"
}

# Run main function
main "$@"