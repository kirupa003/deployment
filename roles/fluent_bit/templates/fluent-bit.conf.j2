# Fluent Bit Configuration
# Generated by Ansible - Do not edit manually

[SERVICE]
    Flush         {{ fluent_bit_service_config.flush }}
    Daemon        {{ fluent_bit_service_config.daemon }}
    Log_Level     {{ fluent_bit_service_config.log_level }}
    Parsers_File  {{ fluent_bit_config_dir }}/{{ fluent_bit_service_config.parsers_file }}
    Plugins_File  {{ fluent_bit_config_dir }}/{{ fluent_bit_service_config.plugins_file }}
    HTTP_Server   {{ fluent_bit_service_config.http_server }}
    HTTP_Listen   {{ fluent_bit_service_config.http_listen }}
    HTTP_Port     {{ fluent_bit_service_config.http_port }}
    storage.path              {{ fluent_bit_service_config.storage_path }}
    storage.sync              {{ fluent_bit_service_config.storage_sync }}
    storage.checksum          {{ fluent_bit_service_config.storage_checksum }}
    storage.backlog.mem_limit {{ fluent_bit_service_config.storage_backlog_mem_limit }}

# DNS Log Inputs
{% for log_path in fluent_bit_dns_log_paths %}
[INPUT]
    Name              tail
    Tag               dns.{{ log_path | basename | replace('.log', '') }}
    Path              {{ log_path }}
    Parser            dns_query
    DB                {{ fluent_bit_data_dir }}/{{ log_path | basename | replace('.log', '') }}.db
    Mem_Buf_Limit     {{ fluent_bit_buffer_max_size }}
    Skip_Long_Lines   On
    Refresh_Interval  5
    Read_from_Head    True

{% endfor %}

# CoreDNS specific input
[INPUT]
    Name              tail
    Tag               dns.coredns
    Path              /var/log/coredns/coredns.log
    Parser            coredns
    DB                {{ fluent_bit_data_dir }}/coredns.db
    Mem_Buf_Limit     {{ fluent_bit_buffer_max_size }}
    Skip_Long_Lines   On
    Refresh_Interval  5
    Read_from_Head    True

# System metrics input
[INPUT]
    Name              node_exporter_metrics
    Tag               metrics.node
    Scrape_Interval   30
    Host              127.0.0.1
    Port              9100
    Metrics_Path      /metrics

# Filters
{% for filter in fluent_bit_filters %}
[FILTER]
    Name    {{ filter.name }}
    Match   {{ filter.match }}
{% if filter.operations is defined %}
{% for operation in filter.operations %}
    {{ operation }}
{% endfor %}
{% endif %}
{% if filter.regex is defined %}
    Regex   {{ filter.regex }}
{% endif %}

{% endfor %}

# Add hostname and metadata
[FILTER]
    Name    modify
    Match   dns.*
    Add     hostname {{ ansible_hostname }}
    Add     region {{ ansible_ec2_placement_region | default('unknown') }}
    Add     environment {{ environment | default('production') }}
    Add     server_type vpn

# Parse DNS query logs
[FILTER]
    Name    parser
    Match   dns.*
    Key_Name log
    Parser  dns_query
    Reserve_Data On

# ClickHouse Output
{% if not fluent_bit_kafka_enabled %}
[OUTPUT]
    Name                     http
    Match                    dns.*
    Host                     {{ fluent_bit_clickhouse_host }}
    Port                     {{ fluent_bit_clickhouse_port }}
    URI                      /
    Format                   json
    Json_date_key            timestamp
    Json_date_format         iso8601
{% if fluent_bit_clickhouse_username and fluent_bit_clickhouse_password %}
    HTTP_User                {{ fluent_bit_clickhouse_username }}
    HTTP_Passwd              {{ fluent_bit_clickhouse_password }}
{% endif %}
    Header                   Content-Type application/json
    Header                   X-ClickHouse-Database {{ fluent_bit_clickhouse_database }}
    Header                   X-ClickHouse-Format JSONEachRow
    tls                      {{ 'on' if fluent_bit_clickhouse_tls else 'off' }}
    tls.verify               {{ 'on' if fluent_bit_clickhouse_tls else 'off' }}
    Retry_Limit              3
    workers                  2
{% endif %}

# Kafka Output (alternative)
{% if fluent_bit_kafka_enabled %}
[OUTPUT]
    Name           kafka
    Match          dns.*
    Brokers        {{ fluent_bit_kafka_brokers }}
    Topics         {{ fluent_bit_kafka_topic }}
    Timestamp_Key  timestamp
    Retry_Limit    3
    rdkafka.client.id            fluent-bit-{{ ansible_hostname }}
    rdkafka.request.required.acks 1
    rdkafka.log_level            3
{% endif %}

# Stdout output for debugging (disabled in production)
# [OUTPUT]
#     Name   stdout
#     Match  dns.*
#     Format json_lines

# File output for backup
[OUTPUT]
    Name          file
    Match         dns.*
    Path          {{ fluent_bit_log_dir }}
    File          dns_backup.log
    Format        json_lines