#!/bin/bash
# Promtail Log Processing Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
LOG_DIR="{{ promtail_log_dir }}"
DATA_DIR="{{ promtail_data_dir }}"
POSITIONS_FILE="{{ promtail_positions_file }}"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_DIR/processor.log"
}

# Function to process VPN logs
process_vpn_logs() {
    local log_type="$1"
    local log_file="$2"
    
    if [[ ! -f "$log_file" ]]; then
        return 0
    fi
    
    # Process based on log type
    case "$log_type" in
        "wireguard")
            # Extract WireGuard connection events
            grep -E "(Handshake|Connection|Peer)" "$log_file" 2>/dev/null | \
            while IFS= read -r line; do
                # Add structured labels for WireGuard events
                echo "$line" | sed 's/^/[VPN=wireguard] /'
            done >> "$DATA_DIR/processed_vpn.log"
            ;;
        "openvpn")
            # Extract OpenVPN connection events
            grep -E "(CONNECT|DISCONNECT|AUTH)" "$log_file" 2>/dev/null | \
            while IFS= read -r line; do
                # Add structured labels for OpenVPN events
                echo "$line" | sed 's/^/[VPN=openvpn] /'
            done >> "$DATA_DIR/processed_vpn.log"
            ;;
        "auth")
            # Extract authentication events
            grep -E "(ssh|sudo|su|login)" "$log_file" 2>/dev/null | \
            while IFS= read -r line; do
                # Add structured labels for auth events
                echo "$line" | sed 's/^/[AUTH] /'
            done >> "$DATA_DIR/processed_auth.log"
            ;;
    esac
}

# Function to clean old processed logs
cleanup_processed_logs() {
    local retention_days=7
    
    find "$DATA_DIR" -name "processed_*.log" -type f -mtime +$retention_days -delete 2>/dev/null || true
    log_message "Cleaned up processed logs older than $retention_days days"
}

# Function to check promtail health
check_promtail_health() {
    if ! systemctl is-active --quiet promtail; then
        log_message "WARNING: Promtail service is not running"
        return 1
    fi
    
    # Check if positions file is being updated
    if [[ -f "$POSITIONS_FILE" ]]; then
        local positions_age
        positions_age=$(stat -c %Y "$POSITIONS_FILE" 2>/dev/null || echo "0")
        local current_time
        current_time=$(date +%s)
        local age_diff=$((current_time - positions_age))
        
        if [[ $age_diff -gt 300 ]]; then  # 5 minutes
            log_message "WARNING: Positions file not updated in $age_diff seconds"
            return 1
        fi
    fi
    
    log_message "Promtail health check passed"
    return 0
}

# Function to generate log statistics
generate_log_stats() {
    local stats_file="$DATA_DIR/log_stats.json"
    
    {
        echo "{"
        echo "  \"timestamp\": \"$(date -Iseconds)\","
        echo "  \"hostname\": \"{{ ansible_hostname }}\","
        echo "  \"region\": \"{{ ansible_ec2_placement_region | default('unknown') }}\","
        
        # Count log lines by type
        echo "  \"log_counts\": {"
        
        # System logs
        local syslog_count
        syslog_count=$(wc -l < /var/log/syslog 2>/dev/null || echo "0")
        echo "    \"syslog\": $syslog_count,"
        
        # Auth logs
        local auth_count
        auth_count=$(wc -l < /var/log/auth.log 2>/dev/null || echo "0")
        echo "    \"auth\": $auth_count,"
        
        # VPN logs
        local wg_count ovpn_count
        wg_count=$(find /var/log -name "*wireguard*" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        ovpn_count=$(find /var/log -name "*openvpn*" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        echo "    \"wireguard\": $wg_count,"
        echo "    \"openvpn\": $ovpn_count"
        
        echo "  },"
        
        # Disk usage
        local log_disk_usage
        log_disk_usage=$(du -sb /var/log 2>/dev/null | awk '{print $1}' || echo "0")
        echo "  \"disk_usage_bytes\": $log_disk_usage,"
        
        # Promtail status
        local promtail_status
        if systemctl is-active --quiet promtail; then
            promtail_status="active"
        else
            promtail_status="inactive"
        fi
        echo "  \"promtail_status\": \"$promtail_status\""
        
        echo "}"
    } > "$stats_file"
    
    # Set proper permissions
    chown {{ promtail_user }}:{{ promtail_group }} "$stats_file" 2>/dev/null || true
    chmod 644 "$stats_file" 2>/dev/null || true
}

# Main execution
main() {
    log_message "Starting log processing"
    
    # Ensure directories exist
    mkdir -p "$LOG_DIR" "$DATA_DIR"
    
    # Process different types of logs
    process_vpn_logs "wireguard" "/var/log/wireguard/wg0.log"
    process_vpn_logs "openvpn" "/var/log/openvpn/server.log"
    process_vpn_logs "auth" "/var/log/auth.log"
    
    # Health check
    check_promtail_health || log_message "Promtail health check failed"
    
    # Generate statistics
    generate_log_stats
    
    # Cleanup old logs
    cleanup_processed_logs
    
    # Set proper permissions on all files
    chown -R {{ promtail_user }}:{{ promtail_group }} "$DATA_DIR" 2>/dev/null || true
    chmod -R 644 "$DATA_DIR"/*.log 2>/dev/null || true
    
    log_message "Log processing completed"
}

# Run main function
main "$@"