# Promtail Configuration
# Generated by Ansible - Do not edit manually

server:
  http_listen_port: {{ promtail_server_config.http_listen_port }}
  http_listen_address: {{ promtail_server_config.http_listen_address }}
  grpc_listen_port: {{ promtail_server_config.grpc_listen_port }}
  log_level: {{ promtail_server_config.log_level }}
  log_format: {{ promtail_server_config.log_format }}

positions:
  filename: {{ promtail_positions_file }}

clients:
  - url: {{ promtail_client_config.url }}
{% if promtail_loki_tenant_id %}
    tenant_id: {{ promtail_loki_tenant_id }}
{% endif %}
{% if promtail_loki_username and promtail_loki_password %}
    basic_auth:
      username: {{ promtail_loki_username }}
      password: {{ promtail_loki_password }}
{% endif %}
    batchwait: {{ promtail_client_config.batchwait }}
    batchsize: {{ promtail_client_config.batchsize }}
    timeout: {{ promtail_client_config.timeout }}
    backoff_config:
      min_period: {{ promtail_client_config.backoff_config.min_period }}
      max_period: {{ promtail_client_config.backoff_config.max_period }}
      max_retries: {{ promtail_client_config.backoff_config.max_retries }}
    external_labels:
{% for key, value in promtail_client_config.external_labels.items() %}
      {{ key }}: {{ value }}
{% endfor %}

scrape_configs:
{% for config in promtail_scrape_configs %}
  - job_name: {{ config.job_name }}
    static_configs:
{% for static_config in config.static_configs %}
      - targets:
{% for target in static_config.targets %}
          - {{ target }}
{% endfor %}
        labels:
{% for key, value in static_config.labels.items() %}
          {{ key }}: {{ value }}
{% endfor %}
{% endfor %}
{% if promtail_pipeline_stages %}
    pipeline_stages:
{% for stage in promtail_pipeline_stages %}
{% if stage.regex is defined %}
      - regex:
          expression: '{{ stage.regex.expression }}'
{% endif %}
{% if stage.timestamp is defined %}
      - timestamp:
          source: {{ stage.timestamp.source }}
          format: "{{ stage.timestamp.format }}"
{% endif %}
{% if stage.labels is defined %}
      - labels:
{% for key, value in stage.labels.items() %}
          {{ key }}: {{ value if value else '' }}
{% endfor %}
{% endif %}
{% if stage.json is defined %}
      - json:
          expressions:
{% for key, value in stage.json.expressions.items() %}
            {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% if stage.multiline is defined %}
      - multiline:
          firstline: '{{ stage.multiline.firstline }}'
          max_wait_time: {{ stage.multiline.max_wait_time | default('3s') }}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}

# Limits configuration
limits_config:
  readline_rate_enabled: true
  readline_rate: 10000
  readline_burst: 20000

# Target configuration
target_config:
  sync_period: 10s