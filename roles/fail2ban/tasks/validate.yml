---
- name: Validate Fail2Ban installation and configuration
  block:
    - name: Check fail2ban service status
      systemd:
        name: fail2ban
      register: fail2ban_service_status
      become: true

    - name: Verify fail2ban is running
      assert:
        that:
          - fail2ban_service_status.status.ActiveState == "active"
        fail_msg: "Fail2Ban service is not running"
        success_msg: "Fail2Ban service is running successfully"
      when: fail2ban_enabled

    - name: Test fail2ban client connectivity
      command: fail2ban-client ping
      register: fail2ban_ping
      changed_when: false
      become: true
      when: fail2ban_enabled

    - name: Verify fail2ban client response
      assert:
        that:
          - fail2ban_ping.stdout == "pong"
        fail_msg: "Fail2Ban client is not responding"
        success_msg: "Fail2Ban client is responding correctly"
      when: fail2ban_enabled

    - name: Get active jails
      command: fail2ban-client status
      register: fail2ban_jails
      changed_when: false
      become: true
      when: fail2ban_enabled

    - name: Verify SSH jail is active
      assert:
        that:
          - "'sshd' in fail2ban_jails.stdout"
        fail_msg: "SSH jail is not active"
        success_msg: "SSH jail is active"
      when: fail2ban_enabled and fail2ban_ssh_enabled

    - name: Check jail configurations
      command: "fail2ban-client status {{ item }}"
      register: jail_status
      changed_when: false
      failed_when: false
      become: true
      loop:
        - sshd
        - openvpn
        - wireguard
      when: fail2ban_enabled

    - name: Display jail status
      debug:
        msg: "{{ item.item }} jail: {{ 'Active' if item.rc == 0 else 'Inactive' }}"
      loop: "{{ jail_status.results | default([]) }}"
      when: fail2ban_enabled

    - name: Test configuration syntax
      command: fail2ban-client -t
      register: config_test
      changed_when: false
      become: true
      when: fail2ban_enabled

    - name: Verify configuration syntax
      assert:
        that:
          - config_test.rc == 0
        fail_msg: "Fail2Ban configuration has syntax errors"
        success_msg: "Fail2Ban configuration syntax is valid"
      when: fail2ban_enabled

  tags:
    - fail2ban
    - validate