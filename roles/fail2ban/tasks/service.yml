---
- name: Manage Fail2Ban service
  block:
    - name: Ensure fail2ban service is configured
      systemd:
        name: fail2ban
        state: "{{ fail2ban_service_state }}"
        enabled: "{{ fail2ban_service_enabled }}"
        daemon_reload: true
      become: true
      when: fail2ban_enabled

    - name: Stop and disable fail2ban service
      systemd:
        name: fail2ban
        state: stopped
        enabled: false
      become: true
      when: not fail2ban_enabled

    - name: Wait for fail2ban to be ready
      wait_for:
        port: 0
        timeout: 30
      when: fail2ban_enabled and fail2ban_service_state == 'started'

    - name: Check fail2ban status
      command: fail2ban-client status
      register: fail2ban_status
      changed_when: false
      failed_when: false
      become: true
      when: fail2ban_enabled

    - name: Display fail2ban status
      debug:
        var: fail2ban_status.stdout_lines
      when: fail2ban_enabled and fail2ban_status.rc == 0

  tags:
    - fail2ban
    - service