#!/bin/bash
# WireGuard Client Configuration Backup Script
# Generated by Ansible

set -euo pipefail

CLIENT_CONFIG_DIR="{{ client_config_dir }}"
BACKUP_DIR="/var/backups/wireguard"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/wireguard_clients_$DATE.tar.gz"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Create backup
tar -czf "$BACKUP_FILE" -C "$(dirname "$CLIENT_CONFIG_DIR")" "$(basename "$CLIENT_CONFIG_DIR")"

# Keep only last 30 days of backups
find "$BACKUP_DIR" -name "wireguard_clients_*.tar.gz" -mtime +30 -delete

# Log backup completion
echo "$(date '+%Y-%m-%d %H:%M:%S') - Client configuration backup completed: $BACKUP_FILE" >> /var/log/wireguard/backup.log

echo "Backup completed: $BACKUP_FILE"