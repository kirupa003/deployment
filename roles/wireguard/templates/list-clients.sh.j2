#!/bin/bash
# WireGuard Client Listing Script
# Generated by Ansible

CLIENT_CONFIG_DIR="{{ client_config_dir }}"
WG_INTERFACE="{{ wireguard_interface }}"

echo "WireGuard Client Status Report"
echo "=============================="
echo "Generated: $(date)"
echo ""

# Show interface status
echo "Interface Status:"
wg show "$WG_INTERFACE" 2>/dev/null || echo "Interface $WG_INTERFACE is down"
echo ""

# Show client database
if [[ -f "$CLIENT_CONFIG_DIR/clients.db" ]]; then
    echo "Client Database:"
    echo "Name,Public Key,IP Address,Created,Status"
    echo "----------------------------------------"
    grep -v "^#" "$CLIENT_CONFIG_DIR/clients.db" | while IFS=',' read -r name pubkey privkey ip created status; do
        echo "$name,$pubkey,$ip,$created,$status"
    done
    echo ""
    
    # Count clients by status
    ACTIVE_COUNT=$(grep ",active$" "$CLIENT_CONFIG_DIR/clients.db" | wc -l)
    REVOKED_COUNT=$(grep ",revoked$" "$CLIENT_CONFIG_DIR/clients.db" | wc -l)
    TOTAL_COUNT=$((ACTIVE_COUNT + REVOKED_COUNT))
    
    echo "Summary:"
    echo "  Active clients: $ACTIVE_COUNT"
    echo "  Revoked clients: $REVOKED_COUNT"
    echo "  Total clients: $TOTAL_COUNT"
else
    echo "No client database found"
fi

echo ""
echo "Current WireGuard Peers:"
wg show "$WG_INTERFACE" peers 2>/dev/null | while read -r peer; do
    echo "  $peer"
done