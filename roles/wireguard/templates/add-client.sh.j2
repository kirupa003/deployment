#!/bin/bash
# WireGuard Client Addition Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ client_config_dir }}"
CLIENT_QR_DIR="{{ client_qr_dir }}"
WG_INTERFACE="{{ wireguard_interface }}"
WG_CONFIG="{{ _wireguard_config_path }}"
SERVER_PUBLIC_KEY="{{ wireguard_server_public_key }}"
SERVER_ENDPOINT="{{ ansible_default_ipv4.address }}:{{ wireguard_port }}"
CLIENT_SUBNET="{{ client_subnet }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Check if client already exists
if grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' already exists"
    exit 1
fi

# Generate client keys
CLIENT_PRIVATE_KEY=$(wg genkey)
CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | wg pubkey)

# Find next available IP
NEXT_IP=$(python3 -c "
import ipaddress
import os

network = ipaddress.IPv4Network('$CLIENT_SUBNET')
used_ips = set()

# Read allocated IPs
if os.path.exists('$CLIENT_CONFIG_DIR/ip_allocations.db'):
    with open('$CLIENT_CONFIG_DIR/ip_allocations.db', 'r') as f:
        for line in f:
            if line.strip() and not line.startswith('#'):
                ip = line.split(',')[0]
                used_ips.add(ip)

# Find first available IP
for ip in network.hosts():
    if str(ip) not in used_ips:
        print(str(ip))
        break
")

if [[ -z "$NEXT_IP" ]]; then
    echo "Error: No available IP addresses in subnet $CLIENT_SUBNET"
    exit 1
fi

# Create client configuration
cat > "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf" << EOF
[Interface]
PrivateKey = $CLIENT_PRIVATE_KEY
Address = $NEXT_IP/32
DNS = {{ wireguard_dns | join(', ') if wireguard_dns is not string else wireguard_dns }}
MTU = {{ wireguard_mtu }}

[Peer]
PublicKey = $SERVER_PUBLIC_KEY
Endpoint = $SERVER_ENDPOINT
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = {{ wireguard_persistent_keepalive }}
EOF

# Add client to database
echo "$CLIENT_NAME,$CLIENT_PUBLIC_KEY,$CLIENT_PRIVATE_KEY,$NEXT_IP,$(date -Iseconds),active" >> "$CLIENT_CONFIG_DIR/clients.db"

# Update IP allocation tracking
echo "$NEXT_IP,$CLIENT_NAME,$(date -Iseconds),allocated" >> "$CLIENT_CONFIG_DIR/ip_allocations.db"

# Add peer to WireGuard configuration
cat >> "$WG_CONFIG" << EOF

# Client: $CLIENT_NAME
[Peer]
PublicKey = $CLIENT_PUBLIC_KEY
AllowedIPs = $NEXT_IP/32
EOF

# Reload WireGuard configuration
wg-quick down "$WG_INTERFACE" || true
wg-quick up "$WG_INTERFACE"

# Generate QR code
qrencode -t ansiutf8 < "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"
qrencode -t png -o "$CLIENT_QR_DIR/$CLIENT_NAME.png" < "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"

echo "Client '$CLIENT_NAME' added successfully!"
echo "IP Address: $NEXT_IP"
echo "Configuration: $CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"
echo "QR Code: $CLIENT_QR_DIR/$CLIENT_NAME.png"