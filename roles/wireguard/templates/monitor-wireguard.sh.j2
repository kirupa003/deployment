#!/bin/bash
# WireGuard Service Monitoring Script
# Generated by Ansible

WG_INTERFACE="{{ wireguard_interface }}"
LOG_FILE="/var/log/wireguard/monitor.log"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check if WireGuard interface is up
if ! wg show "$WG_INTERFACE" &>/dev/null; then
    log_message "ERROR: WireGuard interface $WG_INTERFACE is down, attempting restart"
    
    # Try to restart the interface
    if wg-quick up "$WG_INTERFACE" &>/dev/null; then
        log_message "INFO: Successfully restarted WireGuard interface $WG_INTERFACE"
    else
        log_message "ERROR: Failed to restart WireGuard interface $WG_INTERFACE"
        # Send alert (could integrate with monitoring system)
        echo "WireGuard interface $WG_INTERFACE failed to restart on $(hostname)" | \
            logger -t wireguard-monitor -p daemon.error
    fi
else
    # Interface is up, log peer count
    PEER_COUNT=$(wg show "$WG_INTERFACE" peers | wc -l)
    log_message "INFO: WireGuard interface $WG_INTERFACE is up with $PEER_COUNT peers"
fi

# Check dashboard if enabled
{% if wg_dashboard_enabled %}
if ! curl -s -f "http://localhost:{{ wg_dashboard_port }}" &>/dev/null; then
    log_message "WARNING: WireGuard dashboard is not responding"
    
    # Try to restart dashboard
    if systemctl restart wireguard-dashboard &>/dev/null; then
        log_message "INFO: Successfully restarted WireGuard dashboard"
    else
        log_message "ERROR: Failed to restart WireGuard dashboard"
    fi
fi
{% endif %}