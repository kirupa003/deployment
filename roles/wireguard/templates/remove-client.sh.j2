#!/bin/bash
# WireGuard Client Removal Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ client_config_dir }}"
CLIENT_QR_DIR="{{ client_qr_dir }}"
WG_INTERFACE="{{ wireguard_interface }}"
WG_CONFIG="{{ _wireguard_config_path }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Check if client exists
if ! grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' not found"
    exit 1
fi

# Get client public key
CLIENT_PUBLIC_KEY=$(grep "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" | cut -d',' -f2)

# Remove peer from WireGuard configuration
sed -i "/# Client: $CLIENT_NAME/,/^$/d" "$WG_CONFIG"

# Move client configuration to revoked
if [[ -f "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf" ]]; then
    mv "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf" "$CLIENT_CONFIG_DIR/revoked/"
fi

# Update client database
sed -i "s/^$CLIENT_NAME,\(.*\),active$/$CLIENT_NAME,\1,revoked/" "$CLIENT_CONFIG_DIR/clients.db"

# Update IP allocation tracking
CLIENT_IP=$(grep "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" | cut -d',' -f4)
sed -i "s/^$CLIENT_IP,$CLIENT_NAME,\(.*\),allocated$/$CLIENT_IP,$CLIENT_NAME,\1,revoked/" "$CLIENT_CONFIG_DIR/ip_allocations.db"

# Remove QR code
rm -f "$CLIENT_QR_DIR/$CLIENT_NAME.png"

# Reload WireGuard configuration
wg-quick down "$WG_INTERFACE" || true
wg-quick up "$WG_INTERFACE"

echo "Client '$CLIENT_NAME' removed successfully!"
echo "Configuration moved to: $CLIENT_CONFIG_DIR/revoked/$CLIENT_NAME.conf"