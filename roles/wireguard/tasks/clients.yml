---
# WireGuard Client Management

- name: Create client management directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - "{{ client_config_dir }}/active"
    - "{{ client_config_dir }}/revoked"
    - "{{ client_qr_dir }}"

- name: Create client database file
  copy:
    content: |
      # WireGuard Client Database
      # Format: client_name,public_key,private_key,ip_address,created_date,status
    dest: "{{ client_config_dir }}/clients.db"
    owner: root
    group: root
    mode: '0600'
    force: false
  become: true

- name: Create client IP allocation tracking
  copy:
    content: |
      # IP Address Allocation Tracking
      # Format: ip_address,client_name,allocated_date,status
      {{ wireguard_server_ip }},server,{{ ansible_date_time.iso8601 }},reserved
    dest: "{{ client_config_dir }}/ip_allocations.db"
    owner: root
    group: root
    mode: '0644'
    force: false
  become: true

- name: Create client management scripts
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - src: add-client.sh.j2
      dest: /usr/local/bin/wg-add-client
    - src: remove-client.sh.j2
      dest: /usr/local/bin/wg-remove-client
    - src: list-clients.sh.j2
      dest: /usr/local/bin/wg-list-clients
    - src: generate-qr.sh.j2
      dest: /usr/local/bin/wg-generate-qr

- name: Create web server for QR codes
  template:
    src: qr-server.py.j2
    dest: /usr/local/bin/qr-server.py
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Install Python dependencies for QR server
  apt:
    name:
      - python3
      - python3-pip
      - python3-qrcode
      - python3-flask
    state: present
  become: true

- name: Create systemd service for QR server
  template:
    src: qr-server.service.j2
    dest: /etc/systemd/system/qr-server.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: reload systemd

- name: Enable QR server service
  systemd:
    name: qr-server
    state: started
    enabled: true
    daemon_reload: true
  become: true

- name: Create client configuration backup script
  template:
    src: backup-clients.sh.j2
    dest: /usr/local/bin/wg-backup-clients
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Setup client configuration backup cron job
  cron:
    name: "WireGuard client backup"
    minute: "0"
    hour: "2"
    job: "/usr/local/bin/wg-backup-clients"
    user: root
  become: true