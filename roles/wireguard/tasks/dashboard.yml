---
# WireGuard Dashboard Deployment

- name: Create dashboard directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - "{{ wg_dashboard_data_dir }}"
    - "{{ wg_dashboard_config_dir }}"
    - "{{ wg_dashboard_data_dir }}/db"

- name: Generate dashboard configuration
  template:
    src: dashboard-config.ini.j2
    dest: "{{ wg_dashboard_config_dir }}/wg-dashboard.ini"
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart wireguard dashboard

- name: Create Docker Compose file for dashboard
  template:
    src: docker-compose.yml.j2
    dest: "{{ wg_dashboard_data_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart wireguard dashboard

- name: Create dashboard environment file
  template:
    src: dashboard.env.j2
    dest: "{{ wg_dashboard_data_dir }}/.env"
    owner: root
    group: root
    mode: '0600'
  become: true
  notify: restart wireguard dashboard

- name: Create dashboard startup script
  template:
    src: start-dashboard.sh.j2
    dest: "{{ wg_dashboard_data_dir }}/start-dashboard.sh"
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Pull WireGuard dashboard Docker image
  docker_image:
    name: "{{ wg_dashboard_docker_image }}"
    source: pull
  become: true

- name: Start WireGuard dashboard
  docker_compose:
    project_src: "{{ wg_dashboard_data_dir }}"
    state: present
  become: true

- name: Create systemd service for dashboard
  template:
    src: wireguard-dashboard.service.j2
    dest: /etc/systemd/system/wireguard-dashboard.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify:
    - reload systemd

- name: Enable and start dashboard service
  systemd:
    name: wireguard-dashboard
    state: started
    enabled: true
    daemon_reload: true
  become: true

- name: Wait for dashboard to be ready
  uri:
    url: "http://localhost:{{ wg_dashboard_port }}"
    method: GET
    status_code: 200
  register: dashboard_check
  until: dashboard_check.status == 200
  retries: 30
  delay: 2
  ignore_errors: true