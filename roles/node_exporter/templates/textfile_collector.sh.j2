#!/bin/bash
# Node Exporter Textfile Collector Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

TEXTFILE_DIR="{{ node_exporter_textfile_dir }}"
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

# Function to write metric to temporary file
write_metric() {
    local metric_name="$1"
    local metric_value="$2"
    local metric_help="$3"
    local metric_type="${4:-gauge}"
    local labels="${5:-}"
    
    {
        echo "# HELP $metric_name $metric_help"
        echo "# TYPE $metric_name $metric_type"
        if [ -n "$labels" ]; then
            echo "${metric_name}{${labels}} $metric_value"
        else
            echo "$metric_name $metric_value"
        fi
    } >> "$TEMP_DIR/custom_metrics.prom"
}

# Collect VPN-specific metrics
collect_vpn_metrics() {
    # WireGuard peer count
    if command -v wg >/dev/null 2>&1; then
        local wg_peers
        wg_peers=$(wg show all peers 2>/dev/null | wc -l || echo "0")
        write_metric "node_wireguard_peers_total" "$wg_peers" "Total number of WireGuard peers"
    fi
    
    # OpenVPN connections
    if [ -f /var/log/openvpn/status.log ]; then
        local ovpn_clients
        ovpn_clients=$(grep -c "^CLIENT_LIST" /var/log/openvpn/status.log 2>/dev/null || echo "0")
        write_metric "node_openvpn_clients_total" "$ovpn_clients" "Total number of OpenVPN clients"
    fi
    
    # Check if VPN services are running
    for service in wg-quick@wg0 openvpn@server; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            write_metric "node_vpn_service_up" "1" "VPN service status" "gauge" "service=\"$service\""
        else
            write_metric "node_vpn_service_up" "0" "VPN service status" "gauge" "service=\"$service\""
        fi
    done
}

# Collect system health metrics
collect_system_metrics() {
    # Load average
    local load1 load5 load15
    read -r load1 load5 load15 _ < /proc/loadavg
    write_metric "node_load1_custom" "$load1" "1m load average"
    write_metric "node_load5_custom" "$load5" "5m load average"
    write_metric "node_load15_custom" "$load15" "15m load average"
    
    # Memory usage percentage
    local mem_total mem_available mem_used_percent
    mem_total=$(awk '/MemTotal:/ {print $2}' /proc/meminfo)
    mem_available=$(awk '/MemAvailable:/ {print $2}' /proc/meminfo)
    mem_used_percent=$(awk "BEGIN {printf \"%.2f\", (($mem_total - $mem_available) / $mem_total) * 100}")
    write_metric "node_memory_used_percent" "$mem_used_percent" "Memory usage percentage"
    
    # Disk usage for root filesystem
    local disk_usage
    disk_usage=$(df / | awk 'NR==2 {gsub(/%/, "", $5); print $5}')
    write_metric "node_filesystem_used_percent" "$disk_usage" "Root filesystem usage percentage" "gauge" "mountpoint=\"/\""
}

# Collect network metrics
collect_network_metrics() {
    # Network interface statistics
    while IFS= read -r line; do
        if [[ $line =~ ^[[:space:]]*([^:]+):[[:space:]]*([0-9]+)[[:space:]]+([0-9]+) ]]; then
            local interface="${BASH_REMATCH[1]}"
            local rx_bytes="${BASH_REMATCH[2]}"
            local tx_bytes="${BASH_REMATCH[3]}"
            
            # Skip loopback and docker interfaces
            if [[ ! $interface =~ ^(lo|docker|veth) ]]; then
                write_metric "node_network_receive_bytes_custom" "$rx_bytes" "Network interface receive bytes" "counter" "device=\"$interface\""
                write_metric "node_network_transmit_bytes_custom" "$tx_bytes" "Network interface transmit bytes" "counter" "device=\"$interface\""
            fi
        fi
    done < /proc/net/dev
}

# Main execution
main() {
    # Create temporary metrics file
    touch "$TEMP_DIR/custom_metrics.prom"
    
    # Collect all metrics
    collect_vpn_metrics
    collect_system_metrics
    collect_network_metrics
    
    # Add timestamp
    echo "# Custom metrics collected at $(date)" >> "$TEMP_DIR/custom_metrics.prom"
    write_metric "node_textfile_scrape_timestamp" "$(date +%s)" "Timestamp of last textfile collector run"
    
    # Atomically move the file to the textfile directory
    mv "$TEMP_DIR/custom_metrics.prom" "$TEXTFILE_DIR/custom_metrics.prom"
    
    # Set proper permissions
    chown {{ node_exporter_user }}:{{ node_exporter_group }} "$TEXTFILE_DIR/custom_metrics.prom"
    chmod 644 "$TEXTFILE_DIR/custom_metrics.prom"
}

# Run main function
main "$@"