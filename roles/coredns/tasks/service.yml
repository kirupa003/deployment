---
- name: Enable and start CoreDNS service
  systemd:
    name: coredns
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

- name: Wait for CoreDNS to be ready
  wait_for:
    port: "{{ coredns_listen_port }}"
    host: "{{ coredns_listen_address }}"
    delay: 5
    timeout: 30
  when: coredns_listen_address != "0.0.0.0"

- name: Wait for CoreDNS health endpoint
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ coredns_health_port }}/health"
    method: GET
    status_code: 200
  register: health_check
  until: health_check.status == 200
  retries: 10
  delay: 3

- name: Check CoreDNS metrics endpoint
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ coredns_metrics_port }}/metrics"
    method: GET
    status_code: 200
  register: metrics_check
  failed_when: false

- name: Display CoreDNS service status
  debug:
    msg: |
      CoreDNS service is running
      Health check: {{ health_check.status }}
      Metrics endpoint: {{ 'Available' if metrics_check.status == 200 else 'Not available' }}
      DNS port: {{ coredns_listen_port }}
      Metrics port: {{ coredns_metrics_port }}
      Health port: {{ coredns_health_port }}