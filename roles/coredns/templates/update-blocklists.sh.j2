#!/bin/bash
# CoreDNS Blocklist Update Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BLOCKLIST_DIR="{{ coredns_data_dir }}/blocklists"
TEMP_DIR="/tmp/coredns-blocklists-$$"
LOG_FILE="{{ coredns_log_dir }}/blocklist-update.log"
COMBINED_FILE="${BLOCKLIST_DIR}/combined-blocklist.txt"
PROCESSOR_SCRIPT="{{ coredns_home }}/process-blocklist.py"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

# Cleanup function
cleanup() {
    rm -rf "${TEMP_DIR}"
}
trap cleanup EXIT

# Create temporary directory
mkdir -p "${TEMP_DIR}"
mkdir -p "${BLOCKLIST_DIR}"

log "Starting blocklist update process"

# Download and process each blocklist
{% for list in coredns_adblock_lists %}
log "Downloading {{ list.name }} blocklist from {{ list.url }}"
if curl -fsSL --max-time 60 "{{ list.url }}" -o "${TEMP_DIR}/{{ list.name }}.txt"; then
    log "Successfully downloaded {{ list.name }} blocklist"
    
    # Process the blocklist based on format
    case "{{ list.format }}" in
        "hosts")
            # Extract domains from hosts file format
            grep -E '^(0\.0\.0\.0|127\.0\.0\.1)\s+' "${TEMP_DIR}/{{ list.name }}.txt" | \
            awk '{print $2}' | \
            grep -v '^localhost$' | \
            grep -v '^#' | \
            sort -u > "${TEMP_DIR}/{{ list.name }}_processed.txt"
            ;;
        "adguard"|"adblock")
            # Process AdGuard/AdBlock format using Python script
            python3 "${PROCESSOR_SCRIPT}" "${TEMP_DIR}/{{ list.name }}.txt" "{{ list.format }}" > "${TEMP_DIR}/{{ list.name }}_processed.txt"
            ;;
        *)
            log "Unknown format {{ list.format }} for {{ list.name }}, skipping"
            continue
            ;;
    esac
    
    log "Processed {{ list.name }} blocklist: $(wc -l < "${TEMP_DIR}/{{ list.name }}_processed.txt") domains"
else
    log "Failed to download {{ list.name }} blocklist"
fi
{% endfor %}

# Combine all processed blocklists
log "Combining all blocklists"
cat "${TEMP_DIR}"/*_processed.txt 2>/dev/null | \
    sort -u | \
    grep -E '^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$' | \
    grep -v '^localhost$' > "${TEMP_DIR}/combined.txt" || true

# Convert to hosts file format for CoreDNS
if [ -s "${TEMP_DIR}/combined.txt" ]; then
    {
        echo "# CoreDNS Blocklist - Generated on $(date)"
        echo "# Total blocked domains: $(wc -l < "${TEMP_DIR}/combined.txt")"
        echo ""
        while read -r domain; do
            echo "0.0.0.0 ${domain}"
        done < "${TEMP_DIR}/combined.txt"
    } > "${TEMP_DIR}/final_blocklist.txt"
    
    # Atomic update of the blocklist file
    mv "${TEMP_DIR}/final_blocklist.txt" "${COMBINED_FILE}"
    
    DOMAIN_COUNT=$(wc -l < "${COMBINED_FILE}")
    log "Successfully updated combined blocklist with ${DOMAIN_COUNT} domains"
    
    # Update file permissions
    chown {{ coredns_user }}:{{ coredns_group }} "${COMBINED_FILE}"
    chmod 644 "${COMBINED_FILE}"
    
    # Reload CoreDNS if it's running
    if systemctl is-active --quiet coredns; then
        log "Reloading CoreDNS configuration"
        systemctl reload coredns || log "Failed to reload CoreDNS"
    fi
else
    log "No domains found in blocklists, keeping existing file"
fi

log "Blocklist update process completed"