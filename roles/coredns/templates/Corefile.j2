# CoreDNS Configuration File
# Generated by Ansible - Do not edit manually

# Health check endpoint
.:{{ coredns_health_port }} {
    health {
        lameduck 5s
    }
}

# Main DNS server configuration
.:{{ coredns_listen_port }} {
    # Error logging
    errors

    # Health check
    health {{ coredns_listen_address }}:{{ coredns_health_port }}

    # Ready check
    ready

{% if coredns_adblock_enabled | bool %}
    # Ad-blocking using hosts file format
    hosts {{ coredns_data_dir }}/blocklists/combined-blocklist.txt {
        fallthrough
    }

    # Block specific domains with NXDOMAIN response
    file {{ coredns_config_dir }}/blocklist.db blocklist {
        reload 30s
    }
{% endif %}

    # Custom local DNS records
    file {{ coredns_config_dir }}/custom.db local {
        reload 30s
    }

    # DNS forwarding to upstream resolvers
    forward . {% for resolver in coredns_upstream_resolvers %}{{ resolver }} {% endfor %}{
        max_fails 3
        expire 10s
        health_check 5s
        policy round_robin
    }

    # Caching
    cache {{ coredns_cache_ttl }} {
        success {{ coredns_cache_size }}
        denial 300
        prefetch 10 60s
    }

{% if coredns_query_logging | bool %}
    # Query logging
    log . {{ coredns_log_dir }}/query.log {
        class denial error
        format "{{ coredns_log_format }}"
    }
{% endif %}

{% if coredns_analytics_enabled | bool %}
    # Prometheus metrics
    prometheus {{ coredns_listen_address }}:{{ coredns_metrics_port }}

    # DNS analytics
    dnstap {{ coredns_log_dir }}/dnstap.sock full
{% endif %}

    # Load balancing and failover
    loadbalance round_robin

    # Reload configuration automatically
    reload {{ coredns_analytics_export_interval | default('30s') }}

    # Loop detection
    loop
}

# Reverse DNS for private networks
10.in-addr.arpa:{{ coredns_listen_port }} 16.172.in-addr.arpa:{{ coredns_listen_port }} 168.192.in-addr.arpa:{{ coredns_listen_port }} {
    errors
    cache 300
    forward . {% for resolver in coredns_upstream_resolvers %}{{ resolver }} {% endfor %}
}

# IPv6 reverse DNS
ip6.arpa:{{ coredns_listen_port }} {
    errors
    cache 300
    forward . {% for resolver in coredns_upstream_resolvers %}{{ resolver }} {% endfor %}
}