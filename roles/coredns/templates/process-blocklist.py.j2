#!/usr/bin/env python3
"""
CoreDNS Blocklist Processor
Processes various blocklist formats and extracts domain names
Generated by Ansible - Do not edit manually
"""

import sys
import re
import urllib.parse
from typing import Set, Iterator

def process_adguard_format(content: str) -> Iterator[str]:
    """Process AdGuard filter format"""
    for line in content.splitlines():
        line = line.strip()
        
        # Skip comments and empty lines
        if not line or line.startswith('!') or line.startswith('#'):
            continue
            
        # Basic domain blocking rules
        if line.startswith('||') and line.endswith('^'):
            domain = line[2:-1]
            if is_valid_domain(domain):
                yield domain
                
        # Host-based rules
        elif line.startswith('0.0.0.0 ') or line.startswith('127.0.0.1 '):
            parts = line.split()
            if len(parts) >= 2:
                domain = parts[1]
                if is_valid_domain(domain):
                    yield domain

def process_adblock_format(content: str) -> Iterator[str]:
    """Process AdBlock Plus format"""
    for line in content.splitlines():
        line = line.strip()
        
        # Skip comments and empty lines
        if not line or line.startswith('!') or line.startswith('['):
            continue
            
        # Domain blocking rules
        if '||' in line:
            # Extract domain from ||domain.com^ format
            match = re.search(r'\|\|([^/\^]+)', line)
            if match:
                domain = match.group(1)
                if is_valid_domain(domain):
                    yield domain

def is_valid_domain(domain: str) -> bool:
    """Validate domain name format"""
    if not domain or len(domain) > 253:
        return False
        
    # Remove leading/trailing dots
    domain = domain.strip('.')
    
    # Check for valid domain pattern
    pattern = r'^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$'
    
    if not re.match(pattern, domain):
        return False
        
    # Skip localhost and other local domains
    if domain in ['localhost', 'local', 'broadcasthost']:
        return False
        
    # Skip IP addresses
    if re.match(r'^\d+\.\d+\.\d+\.\d+$', domain):
        return False
        
    return True

def main():
    if len(sys.argv) != 3:
        print("Usage: process-blocklist.py <input_file> <format>", file=sys.stderr)
        sys.exit(1)
        
    input_file = sys.argv[1]
    format_type = sys.argv[2].lower()
    
    try:
        with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
    except Exception as e:
        print(f"Error reading file {input_file}: {e}", file=sys.stderr)
        sys.exit(1)
    
    domains: Set[str] = set()
    
    if format_type == 'adguard':
        domains.update(process_adguard_format(content))
    elif format_type == 'adblock':
        domains.update(process_adblock_format(content))
    else:
        print(f"Unsupported format: {format_type}", file=sys.stderr)
        sys.exit(1)
    
    # Output sorted unique domains
    for domain in sorted(domains):
        print(domain)

if __name__ == '__main__':
    main()