#!/bin/bash
# CrowdSec Decision Monitoring Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

LAPI_URL="{{ crowdsec_lapi_url }}"
LOG_FILE="/var/log/crowdsec/decision-monitor.log"
METRICS_FILE="/var/lib/node_exporter/textfile_collector/crowdsec_decisions.prom"

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Get decision statistics
get_decision_stats() {
    local active_bans
    local total_decisions
    local unique_ips
    
    # Get active decisions
    if ! active_bans=$(cscli decisions list -o json 2>/dev/null); then
        log "Failed to retrieve decisions from CrowdSec"
        return 1
    fi
    
    # Parse statistics
    total_decisions=$(echo "$active_bans" | jq '. | length' 2>/dev/null || echo "0")
    unique_ips=$(echo "$active_bans" | jq -r '.[].value' 2>/dev/null | sort -u | wc -l || echo "0")
    
    log "Active decisions: $total_decisions, Unique IPs: $unique_ips"
    
    # Export metrics for Prometheus
    {
        echo "# HELP crowdsec_active_decisions Number of active CrowdSec decisions"
        echo "# TYPE crowdsec_active_decisions gauge"
        echo "crowdsec_active_decisions{hostname=\"{{ ansible_hostname }}\"} $total_decisions"
        echo ""
        echo "# HELP crowdsec_unique_banned_ips Number of unique banned IP addresses"
        echo "# TYPE crowdsec_unique_banned_ips gauge"
        echo "crowdsec_unique_banned_ips{hostname=\"{{ ansible_hostname }}\"} $unique_ips"
        echo ""
        echo "# HELP crowdsec_last_update_timestamp Last update timestamp"
        echo "# TYPE crowdsec_last_update_timestamp gauge"
        echo "crowdsec_last_update_timestamp{hostname=\"{{ ansible_hostname }}\"} $(date +%s)"
    } > "$METRICS_FILE.tmp" && mv "$METRICS_FILE.tmp" "$METRICS_FILE"
}

# Check service health
check_health() {
    local lapi_status=0
    local bouncer_status=0
    
    # Check LAPI
    if curl -s -f "$LAPI_URL/v1/heartbeat" >/dev/null 2>&1; then
        lapi_status=1
        log "LAPI is healthy"
    else
        log "LAPI is unhealthy"
    fi
    
    # Check bouncer service
    if systemctl is-active --quiet crowdsec-firewall-bouncer; then
        bouncer_status=1
        log "Firewall bouncer is running"
    else
        log "Firewall bouncer is not running"
    fi
    
    # Export health metrics
    {
        echo "# HELP crowdsec_lapi_status CrowdSec LAPI health status"
        echo "# TYPE crowdsec_lapi_status gauge"
        echo "crowdsec_lapi_status{hostname=\"{{ ansible_hostname }}\"} $lapi_status"
        echo ""
        echo "# HELP crowdsec_bouncer_status CrowdSec bouncer service status"
        echo "# TYPE crowdsec_bouncer_status gauge"
        echo "crowdsec_bouncer_status{hostname=\"{{ ansible_hostname }}\"} $bouncer_status"
    } >> "$METRICS_FILE.tmp" && mv "$METRICS_FILE.tmp" "$METRICS_FILE"
}

# Get scenario statistics
get_scenario_stats() {
    local scenarios_output
    
    if scenarios_output=$(cscli scenarios list -o json 2>/dev/null); then
        local installed_scenarios
        installed_scenarios=$(echo "$scenarios_output" | jq '. | length' 2>/dev/null || echo "0")
        
        log "Installed scenarios: $installed_scenarios"
        
        {
            echo "# HELP crowdsec_installed_scenarios Number of installed scenarios"
            echo "# TYPE crowdsec_installed_scenarios gauge"
            echo "crowdsec_installed_scenarios{hostname=\"{{ ansible_hostname }}\"} $installed_scenarios"
        } >> "$METRICS_FILE.tmp" && mv "$METRICS_FILE.tmp" "$METRICS_FILE"
    fi
}

# Main monitoring function
main() {
    log "Starting CrowdSec decision monitoring"
    
    # Create metrics directory if it doesn't exist
    mkdir -p "$(dirname "$METRICS_FILE")"
    
    # Initialize metrics file
    : > "$METRICS_FILE.tmp"
    
    # Collect statistics
    get_decision_stats
    check_health
    get_scenario_stats
    
    log "Monitoring cycle completed"
}

main "$@"