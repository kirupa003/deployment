#!/bin/bash
# CrowdSec Firewall Management Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

CROWDSEC_CHAIN="{{ crowdsec_iptables_chain }}"
LAPI_URL="{{ crowdsec_lapi_url }}"
LOG_FILE="/var/log/crowdsec/firewall-manager.log"

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Check if CrowdSec chain exists
check_chain() {
    if iptables -L "$CROWDSEC_CHAIN" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Create CrowdSec chain
create_chain() {
    log "Creating CrowdSec iptables chain: $CROWDSEC_CHAIN"
    iptables -N "$CROWDSEC_CHAIN" 2>/dev/null || true
    iptables -I INPUT -j "$CROWDSEC_CHAIN" 2>/dev/null || true
    iptables -I FORWARD -j "$CROWDSEC_CHAIN" 2>/dev/null || true
}

# Remove CrowdSec chain
remove_chain() {
    log "Removing CrowdSec iptables chain: $CROWDSEC_CHAIN"
    iptables -D INPUT -j "$CROWDSEC_CHAIN" 2>/dev/null || true
    iptables -D FORWARD -j "$CROWDSEC_CHAIN" 2>/dev/null || true
    iptables -F "$CROWDSEC_CHAIN" 2>/dev/null || true
    iptables -X "$CROWDSEC_CHAIN" 2>/dev/null || true
}

# List current decisions
list_decisions() {
    log "Current CrowdSec decisions:"
    cscli decisions list 2>/dev/null || log "Failed to retrieve decisions"
}

# Show chain status
show_status() {
    log "CrowdSec firewall status:"
    if check_chain; then
        log "Chain $CROWDSEC_CHAIN exists"
        iptables -L "$CROWDSEC_CHAIN" -n --line-numbers
    else
        log "Chain $CROWDSEC_CHAIN does not exist"
    fi
}

# Test LAPI connectivity
test_lapi() {
    log "Testing LAPI connectivity to $LAPI_URL"
    if curl -s -f "$LAPI_URL/v1/heartbeat" >/dev/null; then
        log "LAPI is responding"
        return 0
    else
        log "LAPI is not responding"
        return 1
    fi
}

# Main function
main() {
    case "${1:-status}" in
        "create")
            create_chain
            ;;
        "remove")
            remove_chain
            ;;
        "status")
            show_status
            ;;
        "decisions")
            list_decisions
            ;;
        "test")
            test_lapi
            ;;
        "restart")
            remove_chain
            sleep 2
            create_chain
            ;;
        *)
            echo "Usage: $0 {create|remove|status|decisions|test|restart}"
            echo "  create    - Create CrowdSec iptables chain"
            echo "  remove    - Remove CrowdSec iptables chain"
            echo "  status    - Show chain status"
            echo "  decisions - List current decisions"
            echo "  test      - Test LAPI connectivity"
            echo "  restart   - Restart firewall integration"
            exit 1
            ;;
    esac
}

main "$@"