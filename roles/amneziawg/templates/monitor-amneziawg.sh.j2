#!/bin/bash
# AmneziaWG Service Monitoring Script
# Generated by Ansible

AWG_INTERFACE="{{ amneziawg_interface }}"
LOG_FILE="{{ amneziawg_log_dir }}/monitor.log"
AWG_BINARY="{{ _awg_binary }}"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check if AmneziaWG interface is up
if ! $AWG_BINARY show "$AWG_INTERFACE" &>/dev/null; then
    log_message "ERROR: AmneziaWG interface $AWG_INTERFACE is down, attempting restart"
    
    # Try to restart the interface
    if awg-quick up "$AWG_INTERFACE" &>/dev/null; then
        log_message "INFO: Successfully restarted AmneziaWG interface $AWG_INTERFACE"
    else
        log_message "ERROR: Failed to restart AmneziaWG interface $AWG_INTERFACE"
        # Send alert (could integrate with monitoring system)
        echo "AmneziaWG interface $AWG_INTERFACE failed to restart on $(hostname)" | \
            logger -t amneziawg-monitor -p daemon.error
    fi
else
    # Interface is up, log peer count
    PEER_COUNT=$($AWG_BINARY show "$AWG_INTERFACE" peers | wc -l)
    log_message "INFO: AmneziaWG interface $AWG_INTERFACE is up with $PEER_COUNT peers"
fi

# Check kernel module
if ! lsmod | grep -q amneziawg; then
    log_message "ERROR: AmneziaWG kernel module is not loaded"
    
    # Try to load the module
    if modprobe amneziawg &>/dev/null; then
        log_message "INFO: Successfully loaded AmneziaWG kernel module"
    else
        log_message "ERROR: Failed to load AmneziaWG kernel module"
    fi
fi