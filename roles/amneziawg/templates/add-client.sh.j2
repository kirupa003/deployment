#!/bin/bash
# AmneziaWG Client Addition Script
# Generated by Ansible

set -euo pipefail

CLIENT_NAME="$1"
CLIENT_CONFIG_DIR="{{ client_config_dir }}"
CLIENT_QR_DIR="{{ client_qr_dir }}"
AWG_INTERFACE="{{ amneziawg_interface }}"
AWG_CONFIG="{{ _amneziawg_config_path }}"
SERVER_PUBLIC_KEY="{{ amneziawg_server_public_key }}"
SERVER_ENDPOINT="{{ ansible_default_ipv4.address }}:{{ amneziawg_port }}"
CLIENT_SUBNET="{{ client_subnet }}"
AWG_BINARY="{{ _awg_binary }}"

if [[ -z "$CLIENT_NAME" ]]; then
    echo "Usage: $0 <client_name>"
    exit 1
fi

# Check if client already exists
if grep -q "^$CLIENT_NAME," "$CLIENT_CONFIG_DIR/clients.db" 2>/dev/null; then
    echo "Error: Client '$CLIENT_NAME' already exists"
    exit 1
fi

# Generate client keys
CLIENT_PRIVATE_KEY=$($AWG_BINARY genkey)
CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | $AWG_BINARY pubkey)

# Find next available IP
NEXT_IP=$(python3 -c "
import ipaddress
import os

network = ipaddress.IPv4Network('$CLIENT_SUBNET')
used_ips = set()

# Read allocated IPs
if os.path.exists('$CLIENT_CONFIG_DIR/ip_allocations.db'):
    with open('$CLIENT_CONFIG_DIR/ip_allocations.db', 'r') as f:
        for line in f:
            if line.strip() and not line.startswith('#'):
                ip = line.split(',')[0]
                used_ips.add(ip)

# Find first available IP
for ip in network.hosts():
    if str(ip) not in used_ips:
        print(str(ip))
        break
")

if [[ -z "$NEXT_IP" ]]; then
    echo "Error: No available IP addresses in subnet $CLIENT_SUBNET"
    exit 1
fi

# Create client configuration
cat > "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf" << EOF
[Interface]
PrivateKey = $CLIENT_PRIVATE_KEY
Address = $NEXT_IP/32
DNS = {{ amneziawg_dns | join(', ') if amneziawg_dns is not string else amneziawg_dns }}
MTU = {{ amneziawg_mtu }}

[Peer]
PublicKey = $SERVER_PUBLIC_KEY
Endpoint = $SERVER_ENDPOINT
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = {{ amneziawg_persistent_keepalive }}

{% if amneziawg_obfuscation_enabled %}
# Obfuscation parameters
Jc = {{ amneziawg_junk_packet_count }}
Jmin = {{ amneziawg_junk_packet_min_size }}
Jmax = {{ amneziawg_junk_packet_max_size }}
S1 = {{ amneziawg_init_packet_junk_size }}
S2 = {{ amneziawg_response_packet_junk_size }}
H1 = {{ amneziawg_init_packet_magic_header }}
H2 = {{ amneziawg_response_packet_magic_header }}
H3 = {{ amneziawg_underload_packet_magic_header }}
H4 = {{ amneziawg_transport_packet_magic_header }}
{% endif %}
EOF

# Add client to database
echo "$CLIENT_NAME,$CLIENT_PUBLIC_KEY,$CLIENT_PRIVATE_KEY,$NEXT_IP,$(date -Iseconds),active" >> "$CLIENT_CONFIG_DIR/clients.db"

# Update IP allocation tracking
echo "$NEXT_IP,$CLIENT_NAME,$(date -Iseconds),allocated" >> "$CLIENT_CONFIG_DIR/ip_allocations.db"

# Add peer to AmneziaWG configuration
cat >> "$AWG_CONFIG" << EOF

# Client: $CLIENT_NAME
[Peer]
PublicKey = $CLIENT_PUBLIC_KEY
AllowedIPs = $NEXT_IP/32
EOF

# Reload AmneziaWG configuration
awg-quick down "$AWG_INTERFACE" || true
awg-quick up "$AWG_INTERFACE"

# Generate QR code
qrencode -t ansiutf8 < "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"
qrencode -t png -o "$CLIENT_QR_DIR/$CLIENT_NAME.png" < "$CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"

echo "Client '$CLIENT_NAME' added successfully!"
echo "IP Address: $NEXT_IP"
echo "Configuration: $CLIENT_CONFIG_DIR/active/$CLIENT_NAME.conf"
echo "QR Code: $CLIENT_QR_DIR/$CLIENT_NAME.png"