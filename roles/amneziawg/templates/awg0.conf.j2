# AmneziaWG Server Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

[Interface]
# Server private key
PrivateKey = {{ amneziawg_server_private_key }}

# Server IP address within the VPN network
Address = {{ amneziawg_server_ip }}/{{ amneziawg_network.split('/')[1] }}

# Port to listen on
ListenPort = {{ amneziawg_port }}

# MTU for the interface
MTU = {{ amneziawg_mtu }}

# DNS servers for clients
{% if amneziawg_dns is string %}
DNS = {{ amneziawg_dns }}
{% else %}
DNS = {{ amneziawg_dns | join(', ') }}
{% endif %}

{% if amneziawg_obfuscation_enabled %}
# Obfuscation parameters
Jc = {{ amneziawg_junk_packet_count }}
Jmin = {{ amneziawg_junk_packet_min_size }}
Jmax = {{ amneziawg_junk_packet_max_size }}
S1 = {{ amneziawg_init_packet_junk_size }}
S2 = {{ amneziawg_response_packet_junk_size }}
H1 = {{ amneziawg_init_packet_magic_header }}
H2 = {{ amneziawg_response_packet_magic_header }}
H3 = {{ amneziawg_underload_packet_magic_header }}
H4 = {{ amneziawg_transport_packet_magic_header }}
{% endif %}

# Post-up and post-down scripts for NAT and routing
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o {{ amneziawg_forward_interface }} -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o {{ amneziawg_forward_interface }} -j MASQUERADE

# Client configurations will be added here by management scripts
# Each client will have a [Peer] section with their public key and allowed IPs