---
# Install cloudflared

- name: Install cloudflared via package manager
  when: cloudflared_install_method == 'package'
  block:
    - name: Add Cloudflare GPG key
      apt_key:
        url: https://pkg.cloudflare.com/cloudflare-main.gpg
        keyring: /usr/share/keyrings/cloudflare-main.gpg
        state: present

    - name: Add Cloudflare repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared {{ ansible_distribution_release }} main"
        state: present
        filename: cloudflared

    - name: Install cloudflared package
      apt:
        name: cloudflared
        state: "{{ 'latest' if cloudflared_version == 'latest' else 'present' }}"
        update_cache: true

- name: Install cloudflared via binary
  when: cloudflared_install_method == 'binary'
  block:
    - name: Get latest cloudflared version
      uri:
        url: https://api.github.com/repos/cloudflare/cloudflared/releases/latest
        return_content: true
      register: cloudflared_latest
      when: cloudflared_version == 'latest'

    - name: Set cloudflared version
      set_fact:
        cloudflared_download_version: "{{ cloudflared_latest.json.tag_name if cloudflared_version == 'latest' else cloudflared_version }}"

    - name: Download cloudflared binary
      get_url:
        url: "https://github.com/cloudflare/cloudflared/releases/download/{{ cloudflared_download_version }}/cloudflared-linux-{{ ansible_architecture | replace('x86_64', 'amd64') }}"
        dest: /usr/local/bin/cloudflared
        mode: "0755"

- name: Install cloudflared via Docker
  when: cloudflared_install_method == 'docker'
  block:
    - name: Ensure Docker is installed
      apt:
        name:
          - docker.io
          - docker-compose
        state: present

    - name: Create cloudflared Docker directory
      file:
        path: /opt/cloudflared
        state: directory
        mode: "0755"

    - name: Deploy cloudflared Docker Compose
      template:
        src: docker-compose.yml.j2
        dest: /opt/cloudflared/docker-compose.yml
        mode: "0644"

- name: Create cloudflared system user
  user:
    name: "{{ cloudflared_user }}"
    system: true
    shell: /usr/sbin/nologin
    home: "{{ cloudflared_config_dir }}"
    create_home: false

- name: Create cloudflared config directory
  file:
    path: "{{ cloudflared_config_dir }}"
    state: directory
    owner: "{{ cloudflared_user }}"
    group: "{{ cloudflared_user }}"
    mode: "0700"

- name: Verify cloudflared installation
  command: cloudflared --version
  register: cloudflared_version_check
  changed_when: false
  when: cloudflared_install_method != 'docker'

- name: Display cloudflared version
  debug:
    msg: "Installed cloudflared: {{ cloudflared_version_check.stdout }}"
  when: cloudflared_install_method != 'docker'
