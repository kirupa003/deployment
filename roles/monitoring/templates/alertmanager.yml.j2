# Alertmanager Configuration
# Generated by Ansible - Do not edit manually

global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@vpn-infrastructure.local'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 30m
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 2h

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:9093/api/v1/alerts'

  - name: 'critical-alerts'
{% if monitoring_slack_webhook_url != "" %}
    slack_configs:
      - api_url: '{{ monitoring_slack_webhook_url }}'
        channel: '{{ monitoring_slack_channel }}'
        title: 'CRITICAL: VPN Infrastructure Alert'
        text: |
          {{ '{{' }} range .Alerts {{ '}}' }}
          :red_circle: *{{ '{{' }} .Annotations.summary {{ '}}' }}*
          *Description:* {{ '{{' }} .Annotations.description {{ '}}' }}
          *Instance:* {{ '{{' }} .Labels.instance {{ '}}' }}
          *Severity:* {{ '{{' }} .Labels.severity {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
        send_resolved: true
{% endif %}
{% if monitoring_pagerduty_integration_key != "" %}
    pagerduty_configs:
      - routing_key: '{{ monitoring_pagerduty_integration_key }}'
        description: '{{ '{{' }} .CommonAnnotations.summary {{ '}}' }}'
        severity: 'critical'
        class: 'VPN Infrastructure'
        component: '{{ '{{' }} .CommonLabels.instance {{ '}}' }}'
        group: 'Infrastructure'
{% endif %}
{% if monitoring_email_addresses | length > 0 %}
    email_configs:
{% for email in monitoring_email_addresses %}
      - to: '{{ email }}'
        subject: 'CRITICAL: VPN Infrastructure Alert'
        body: |
          Critical alert in VPN infrastructure:
          
          {{ '{{' }} range .Alerts {{ '}}' }}
          Alert: {{ '{{' }} .Annotations.summary {{ '}}' }}
          Description: {{ '{{' }} .Annotations.description {{ '}}' }}
          Instance: {{ '{{' }} .Labels.instance {{ '}}' }}
          Severity: {{ '{{' }} .Labels.severity {{ '}}' }}
          Started: {{ '{{' }} .StartsAt {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
{% endfor %}
{% endif %}

  - name: 'warning-alerts'
{% if monitoring_slack_webhook_url != "" %}
    slack_configs:
      - api_url: '{{ monitoring_slack_webhook_url }}'
        channel: '{{ monitoring_slack_channel }}'
        title: 'WARNING: VPN Infrastructure Alert'
        text: |
          {{ '{{' }} range .Alerts {{ '}}' }}
          :warning: *{{ '{{' }} .Annotations.summary {{ '}}' }}*
          *Description:* {{ '{{' }} .Annotations.description {{ '}}' }}
          *Instance:* {{ '{{' }} .Labels.instance {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
        send_resolved: true
{% endif %}

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']