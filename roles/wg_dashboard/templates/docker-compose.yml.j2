# {{ ansible_managed }}
# WireGuard Dashboard Docker Compose
# Reference: https://wgdashboard.dev/

services:
  wg-dashboard:
    image: {{ wg_dashboard_image }}
    container_name: wg-dashboard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
{% if wg_ipv6_enabled %}
      - net.ipv6.conf.all.forwarding=1
{% endif %}
    environment:
      # Timezone
      - tz={{ wg_dashboard_timezone }}

      # Dashboard settings
      - wgd_port={{ wg_dashboard_port }}
      - global_dns={{ wg_dashboard_global_dns }}
{% if wg_dashboard_public_ip %}
      - public_ip={{ wg_dashboard_public_ip }}
{% else %}
      - public_ip={{ ansible_host }}
{% endif %}

      # Authentication
      - username={{ wg_dashboard_admin_user }}
      - password={{ wg_dashboard_admin_password }}
      - enable_totp={{ wg_dashboard_enable_totp | string | lower }}
{% if wg_dashboard_totp_key %}
      - totp_key={{ wg_dashboard_totp_key }}
{% endif %}

      # Auto-start WireGuard
      - wg_autostart={{ wg_dashboard_wg_autostart | string | lower }}

{% if wg_dashboard_email_enabled %}
      # Email notifications
      - email_server={{ wg_dashboard_email_server }}
      - email_port={{ wg_dashboard_email_port }}
      - email_encryption={{ wg_dashboard_email_encryption }}
      - email_username={{ wg_dashboard_email_username }}
      - email_password={{ wg_dashboard_email_password }}
      - email_from={{ wg_dashboard_email_from }}
{% endif %}

    volumes:
      # WireGuard configurations (stored in SQLite + config files)
      - {{ wg_dashboard_conf_path }}:/etc/wireguard
      # AmneziaWG configurations
      - {{ wg_dashboard_aconf_path }}:/etc/amnezia/amneziawg
      # Dashboard data (SQLite database with all peer configs, settings, logs)
      - {{ wg_dashboard_db_path }}:/data
      # Kernel modules (required for WireGuard)
      - /lib/modules:/lib/modules:ro

    ports:
      # Dashboard web interface
      - "{{ wg_dashboard_port }}:{{ wg_dashboard_port }}/tcp"
      # WireGuard UDP port
      - "{{ wg_listen_port }}:{{ wg_listen_port }}/udp"
{% if vpn_protocol == 'amneziawg' %}
      # AmneziaWG UDP port (if different from WireGuard)
      - "{{ amneziawg_listen_port }}:{{ amneziawg_listen_port }}/udp"
{% endif %}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ wg_dashboard_port }}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "vpn.protocol={{ vpn_protocol | default('wireguard') }}"
      - "vpn.region={{ vpn_region | default('unknown') }}"
      - "vpn.server={{ inventory_hostname }}"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - wg-network

networks:
  wg-network:
    driver: bridge
