#!/bin/bash
# WireGuard Monitoring Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
INTERFACES=({{ wg_exporter_interfaces | join(' ') }})
LOG_FILE="/var/log/wg_exporter/monitor.log"
METRICS_FILE="{{ wg_exporter_data_dir }}/wg_metrics.txt"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$METRICS_FILE")"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Function to collect WireGuard statistics
collect_wg_stats() {
    local interface="$1"
    local temp_file
    temp_file=$(mktemp)
    
    if ! wg show "$interface" > "$temp_file" 2>/dev/null; then
        log_message "ERROR: Failed to get stats for interface $interface"
        rm -f "$temp_file"
        return 1
    fi
    
    # Parse WireGuard output and generate metrics
    {
        echo "# WireGuard Interface Statistics for $interface"
        echo "# Generated at $(date)"
        
        # Interface status
        if wg show "$interface" >/dev/null 2>&1; then
            echo "wireguard_interface_up{interface=\"$interface\"} 1"
        else
            echo "wireguard_interface_up{interface=\"$interface\"} 0"
        fi
        
        # Peer count
        local peer_count
        peer_count=$(wg show "$interface" peers 2>/dev/null | wc -l)
        echo "wireguard_peers_total{interface=\"$interface\"} $peer_count"
        
        # Parse peer information
        while IFS= read -r line; do
            if [[ $line =~ ^peer:\ ([A-Za-z0-9+/=]+)$ ]]; then
                local peer_key="${BASH_REMATCH[1]}"
                local peer_short="${peer_key:0:8}"
                
                # Read next lines for this peer
                read -r endpoint_line || continue
                read -r allowed_ips_line || continue
                read -r latest_handshake_line || continue
                read -r transfer_line || continue
                
                # Parse transfer data
                if [[ $transfer_line =~ transfer:\ ([0-9.]+\ [KMGT]?B)\ received,\ ([0-9.]+\ [KMGT]?B)\ sent ]]; then
                    local received="${BASH_REMATCH[1]}"
                    local sent="${BASH_REMATCH[2]}"
                    
                    # Convert to bytes (simplified - assumes MB for now)
                    local received_bytes sent_bytes
                    received_bytes=$(echo "$received" | sed 's/[^0-9.]//g' | awk '{print int($1 * 1024 * 1024)}')
                    sent_bytes=$(echo "$sent" | sed 's/[^0-9.]//g' | awk '{print int($1 * 1024 * 1024)}')
                    
                    echo "wireguard_peer_receive_bytes_total{interface=\"$interface\",peer=\"$peer_short\"} $received_bytes"
                    echo "wireguard_peer_transmit_bytes_total{interface=\"$interface\",peer=\"$peer_short\"} $sent_bytes"
                fi
                
                # Parse handshake time
                if [[ $latest_handshake_line =~ latest\ handshake:\ (.+)$ ]]; then
                    local handshake_time="${BASH_REMATCH[1]}"
                    if [[ $handshake_time != "0" ]]; then
                        local handshake_timestamp
                        handshake_timestamp=$(date -d "$handshake_time" +%s 2>/dev/null || echo "0")
                        echo "wireguard_peer_last_handshake_seconds{interface=\"$interface\",peer=\"$peer_short\"} $handshake_timestamp"
                    fi
                fi
            fi
        done < "$temp_file"
        
    } > "$METRICS_FILE.tmp"
    
    # Atomically update metrics file
    mv "$METRICS_FILE.tmp" "$METRICS_FILE"
    rm -f "$temp_file"
    
    log_message "Updated metrics for interface $interface"
}

# Function to check WireGuard service health
check_wg_health() {
    local interface="$1"
    
    # Check if interface is up
    if ! ip link show "$interface" >/dev/null 2>&1; then
        log_message "WARNING: Interface $interface is not up"
        return 1
    fi
    
    # Check if WireGuard is configured
    if ! wg show "$interface" >/dev/null 2>&1; then
        log_message "WARNING: WireGuard not configured for interface $interface"
        return 1
    fi
    
    log_message "Interface $interface is healthy"
    return 0
}

# Main execution
main() {
    log_message "Starting WireGuard monitoring check"
    
    local exit_code=0
    
    for interface in "${INTERFACES[@]}"; do
        if check_wg_health "$interface"; then
            collect_wg_stats "$interface" || exit_code=1
        else
            exit_code=1
        fi
    done
    
    # Set proper permissions
    chown {{ wg_exporter_user }}:{{ wg_exporter_group }} "$METRICS_FILE" 2>/dev/null || true
    chmod 644 "$METRICS_FILE" 2>/dev/null || true
    
    log_message "WireGuard monitoring check completed with exit code $exit_code"
    exit $exit_code
}

# Run main function
main "$@"